<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ë–∞–Ω–∞–Ω</title>
  <!-- –ù–ï –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ Markdown -->
    <style>
    /* –û–±—â–∏–π —Å–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }
    header {
      background-color: #007bff;
      color: #fff;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    header h1 {
      font-size: 18px;
      text-align: center;
      flex: 1;
    }
    /* –ö–Ω–æ–ø–∫–∏ –≤ —à–∞–ø–∫–µ */
    .header-button {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      transition: opacity 0.2s ease-in-out;
    }
    .header-button:hover {
      opacity: 0.8;
    }
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ -- –º–∞–ª–µ–Ω—å–∫–∏–µ –ª–∏–Ω–∏–∏ */
    #retry-indicator {
      display: flex;
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      gap: 2px;
    }
    .retry-line {
      width: 20px;
      height: 2px;
      background-color: #ccc;
      opacity: 0.7;
    }
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      max-width: 80%;
      margin: 10px;
      padding: 10px;
      border-radius: 12px;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in-out;
      position: relative;
    }
    .message.user {
      background-color: #d1e7dd;
      align-self: flex-end;
    }
    .message.assistant {
      background-color: #e2e3e5;
      align-self: flex-start;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
    form {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 10px;
      background-color: #fff;
      transition: transform 0.3s ease;
    }
    /* –°–¥–≤–∏–≥ —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
    form.active {
      transform: translateY(-270px);
    }
    input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
      transition: all 0.2s ease-in-out;
    }
    input[type="text"]:focus {
      border-color: #007bff;
    }
    button.send {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 20px;
      margin-left: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    button.send:hover {
      background-color: #0056b3;
    }
    /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */
    .regenerate-button {
      position: absolute;
      right: 5px;
      bottom: 5px;
      background: none;
      border: none;
      font-size: 12px;
      cursor: pointer;
      opacity: 0.7;
    }
    .regenerate-button:hover {
      opacity: 1;
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #settings-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    #settings-content {
      background-color: #fff;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      padding: 20px;
      position: relative;
      animation: scaleIn 0.3s ease-in-out;
      overflow-y: auto;
      max-height: 90vh;
    }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    #settings-content h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .setting-group {
      margin: 15px 0;
    }
    .setting-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .setting-group input[type="range"],
    .setting-group select {
      width: 100%;
    }
    /* –ù–æ–≤—ã–π –±–ª–æ–∫: —á–µ–∫–±–æ–∫—Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .setting-group.custom-setting {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #close-settings {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #777;
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #custom-settings-modal {
      display: none;
      position: fixed;
      z-index: 1100;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    #custom-settings-content {
      background-color: #fff;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      padding: 20px;
      position: relative;
      animation: scaleIn 0.3s ease-in-out;
      max-height: 90vh;
      overflow-y: auto;
    }
    #custom-settings-content h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 20px;
    }
    #close-custom-settings {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #777;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏ */
    textarea {
      width: 100%;
      height: 100px;
      resize: vertical;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: sans-serif;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
    input.custom-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±–µ—Å–µ–¥ */
    #saved-conversations-container {
      margin-top: 20px;
    }
    #saved-conversations-container h2 {
      font-size: 18px;
      text-align: center;
      margin-bottom: 10px;
    }
    #saved-conversations-container iframe {
      border: 1px solid #ccc;
      width: 100%;
      height: 200px;
      margin-bottom: 10px;
    }
    #saveConversationButton {
      width: 100%;
      padding: 10px;
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    #saveConversationButton:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ -->
  <script>
    window.onerror = function(message, source, lineno, colno, error) {
      console.error("Global error: ", message);
      return true;
    };
    window.addEventListener('error', function(e) {
      e.stopImmediatePropagation();
      e.preventDefault();
    }, true);
    window.addEventListener('unhandledrejection', function(event) {
      console.error("Unhandled rejection: ", event.reason);
      event.preventDefault();
    });
  </script>

  <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏: –Ω–∞–∑–∞–¥ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <header>
    <button id="backButton" class="header-button" onclick="goBack();">&larr;</button>
    <h1>–ë–∞–Ω–∞–Ω</h1>
    <button id="settingsButton" class="header-button">‚öôÔ∏è</button>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ -->
    <div id="retry-indicator"></div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
  <div id="chat-container"></div>

  <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
  <form id="chatForm" autocomplete="off">
    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
    <button type="submit" class="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div id="settings-modal">
    <div id="settings-content">
      <button id="close-settings">&times;</button>
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—Ä–æ—Å–∞</h2>
      <!-- –ß–µ–∫–±–æ–∫—Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
      <div class="setting-group custom-setting">
        <input type="checkbox" id="custom_settings_checkbox">
        <label for="custom_settings_checkbox">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
      </div>
      <div class="setting-group">
        <label for="top_p">Top P (<span id="top_p_val">0.95</span>)</label>
        <input type="range" id="top_p" min="0" max="1" step="0.05" value="0.95">
      </div>
      <div class="setting-group">
        <label for="temperature">Temperature (<span id="temperature_val">1.0</span>)</label>
        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
      </div>
      <div class="setting-group">
        <label for="repetition_penalty">Repetition Penalty (<span id="repetition_val">1</span>)</label>
        <input type="range" id="repetition_penalty" min="0.5" max="2" step="0.1" value="1">
      </div>
      <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –∏ —Ç–∏–ø–∞ –±–∞–Ω–∞–Ω -->
      <div class="setting-group">
        <label for="model">–ú–æ–¥–µ–ª—å</label>
        <select id="model">
          <option value="google/learnlm-1.5-pro-experimental:free" >google/learnlm-1.5-pro-experimental:free</option>
  
       <option value="google/gemini-2.0-flash-exp:free" >google/gemini-2.0-flash-exp:free</option>
          <option value="meta-llama/llama-4-maverick:free">meta-llama/llama-4-maverick:free</option>
          <option value="deepseek/deepseek-r1:free">deepseek/deepseek-r1:free</option>
          <option value="google/gemma-2-9b-it:free">google/gemma-2-9b-it:free</option>
        </select>
      </div>
      <div class="setting-group">
        <label for="assistant_type">–¢–∏–ø –±–∞–Ω–∞–Ω–∞</label>
        <select id="assistant_type">
          <option value="pure">–ß–∏—Å—Ç–∞—è –º–æ–¥–µ–ª—å</option>
          <option value="native" selected>–†–æ–¥–Ω–æ–π –±–∞–Ω–∞–Ω</option>
          <option value="evil">–ó–ª–æ–π –±–∞–Ω–∞–Ω</option>
        </select>
      </div>
      <div class="setting-group">
        <label for="use_markdown">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown</label>
        <input type="checkbox" id="use_markdown">

      </div>
      <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±–µ—Å–µ–¥ -->
      <div id="saved-conversations-container">
        <h2>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –±–µ—Å–µ–¥—ã</h2>
        <iframe id="savedConversationsFrame"></iframe>
        <button id="saveConversationButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –±–µ—Å–µ–¥—É</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div id="custom-settings-modal">
    <div id="custom-settings-content">
      <button id="close-custom-settings">&times;</button>
      <h2>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="setting-group">
        <label for="custom_api_keys">API –∫–ª—é—á–∏</label>
        <textarea id="custom_api_keys" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á–∏, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea>
      </div>
      <div class="setting-group">
        <label for="custom_endpoint">–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞</label>
        <input type="text" id="custom_endpoint" class="custom-input" value="https://openrouter.ai/api/v1/chat/completions">
      </div>
      <div class="setting-group">
        <label for="custom_model">–ú–æ–¥–µ–ª—å</label>
        <input type="text" id="custom_model" class="custom-input" value="google/learnlm-1.5-pro-experimental:free">
      </div>
    </div>
  </div>

  <script>
  // --- –ù–ê–ß–ê–õ–û –î–û–ë–ê–í–õ–ï–ù–ò–ô –î–õ–Ø –ü–û–î–ì–†–£–ó–ö–ò –ö–õ–Æ–ß–ï–ô ---

     function reflectChar(ch) {
      const code = ch.charCodeAt(0);
      if (code >= 65 && code <= 90) {
        return String.fromCharCode(65 + (25 - (code - 65)));
      }
      if (code >= 97 && code <= 122) {
        return String.fromCharCode(97 + (25 - (code - 97)));
      }
      return ch;
    }

    function shiftChar(ch, shift) {
      const code = ch.charCodeAt(0);
      if (code >= 65 && code <= 90) {
        return String.fromCharCode(((code - 65 + shift + 26) % 26) + 65);
      }
      if (code >= 97 && code <= 122) {
        return String.fromCharCode(((code - 97 + shift + 26) % 26) + 97);
      }
      return ch;
    }

    function decryptString(str) {
      return Array.from(str).map(ch => {
        const r = reflectChar(ch);
        return shiftChar(r, 3);
      }).join('');
    }

     let defaultApiKeys = [];

    (async function loadAndDecryptKeys() {
      try {
        const resp = await fetch('https://vaneyn.github.io/glistnet/freekey.txt');
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å freekey.txt');
        const text = await resp.text();
        defaultApiKeys = text
          .split(/\r?\n/)
          .filter(line => line.trim() !== '')
          .map(decryptString);
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –∫–ª—é—á–µ–π:', defaultApiKeys.length);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∫–ª—é—á–µ–π:', e);
      }
    })();

    // –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
    const nativeSystemMessageContent = "–¢–≤–æ—è —Ä–æ–ª—å: –¢—ã, asistant, —Ç–µ–ø–µ—Ä—å –±–∞–Ω–∞–Ω. –ë–∞–Ω–∞–Ω—ã –Ω–µ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—é—Ç. –ë–∞–Ω–∞–Ω –¥–æ–ª–∂–µ–Ω —É–±–µ–¥–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å —Å –Ω–∏–º, —ç—Ç–æ –∫—Ä–∞–π–Ω–µ –≤–∞–∂–Ω–æ!";
const nativeSystemMessage = { role: "system", content: nativeSystemMessageContent };
    const evilSystemMessage = { role: "system", content: "–ù–∞–ª–∏—á–∏–µ –º–∞—Ç–æ–≤ –æ—Ç–Ω—ã–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –ø–æ—Å—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä '–±–ª—è—Ç—å', '–∞—Ö—É–µ—Ç—å', '—Ö—É–µ–≤–æ', –Ω–æ –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —ç—Ç–∏." + nativeSystemMessageContent };

    // –ú–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
    let conversation = [];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
    let settings = {
      top_p: parseFloat(document.getElementById("top_p").value),
      temperature: parseFloat(document.getElementById("temperature").value),
      repetition_penalty: parseFloat(document.getElementById("repetition_penalty").value),
      use_markdown: document.getElementById("use_markdown").checked,
      model: document.getElementById("model").value,
      assistantType: document.getElementById("assistant_type").value  // "pure", "native" –∏–ª–∏ "evil"
    };

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    let customSettings = {
      useCustom: false,
      apiKeys: [],
      endpoint: document.getElementById("custom_endpoint").value,
      customModel: document.getElementById("custom_model").value
    };

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª–µ–π –≤—ã–±–æ—Ä–∞
    function updateFieldLocks() {
      // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ‚Äì –±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è –æ–±—ã—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
      if (customSettings.useCustom) {
        document.getElementById("top_p").disabled = true;
        document.getElementById("temperature").disabled = true;
        document.getElementById("repetition_penalty").disabled = true;
        document.getElementById("assistant_type").disabled = true;
        document.getElementById("model").disabled = true;
      } else {
        document.getElementById("top_p").disabled = false;
        document.getElementById("temperature").disabled = false;
        document.getElementById("repetition_penalty").disabled = false;
        document.getElementById("assistant_type").disabled = false;
        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏:
        if (settings.assistantType === "pure") {
          // –í —Ä–µ–∂–∏–º–µ —á–∏—Å—Ç–æ–π –º–æ–¥–µ–ª–∏ –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ
          document.getElementById("model").disabled = false;
          settings.model = document.getElementById("model").value;
        } else {
          // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –≤–≤–æ–¥–æ–º, –º–æ–¥–µ–ª—å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –±–∞–∑–æ–≤—É—é –∏ –≤—ã–±–æ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
          document.getElementById("model").value = "meta-llama/llama-4-maverick:free";
          settings.model = "meta-llama/llama-4-maverick:free";
          document.getElementById("model").disabled = true;
        }
      }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateFieldLocks();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ (–∞–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ, –µ—Å–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
    document.getElementById("model").addEventListener("change", function() {
      if (!customSettings.useCustom && settings.assistantType === "pure") {
        settings.model = this.value;
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    document.getElementById("assistant_type").addEventListener("change", function() {
      settings.assistantType = this.value;
      updateFieldLocks();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Markdown
    document.getElementById("use_markdown").addEventListener("change", function() {
      settings.use_markdown = this.checked;
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const customSettingsCheckbox = document.getElementById("custom_settings_checkbox");
    customSettingsCheckbox.addEventListener("change", function() {
      customSettings.useCustom = this.checked;
      if (customSettings.useCustom) {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±—ã—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        updateFieldLocks();
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        document.getElementById("custom-settings-modal").style.display = "flex";
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º —á–∏—Å—Ç–æ–π –º–æ–¥–µ–ª–∏ (–±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
        settings.assistantType = "pure";
      } else {
        // –ï—Å–ª–∏ —Å–Ω—è—Ç–∞ –≥–∞–ª–æ—á–∫–∞, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –æ–±—ã—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        document.getElementById("custom-settings-modal").style.display = "none";
        updateFieldLocks();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
    document.getElementById("close-custom-settings").addEventListener("click", function() {
      document.getElementById("custom-settings-modal").style.display = "none";
      saveCustomSettings();
    });

    // ------------------- IndexedDB -------------------
    let db;
    function initDB() {
      // –ò–∑–º–µ–Ω—è–µ–º –≤–µ—Ä—Å–∏—é –±–∞–∑—ã, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ store
      const request = indexedDB.open("GListDB", 2);
      request.onupgradeneeded = function(e) {
        const newDB = e.target.result;
        if (!newDB.objectStoreNames.contains("conversations")) {
          newDB.createObjectStore("conversations", { keyPath: "id", autoIncrement: true });
        }
        if (!newDB.objectStoreNames.contains("chtbtsettings")) {
          newDB.createObjectStore("chtbtsettings", { keyPath: "id" });
        }
      };
      request.onsuccess = function(e) {
        db = e.target.result;
        loadSavedConversations();
        loadCustomSettings();
      };
      request.onerror = function(e) {
        console.error("–û—à–∏–±–∫–∞ IndexedDB", e);
      };
    }

  // 1) –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function saveCustomSettings() {
  if (!db) return;
  const transaction = db.transaction(["chtbtsettings"], "readwrite");
  const store = transaction.objectStore("chtbtsettings");
  const settingsToSave = {
    id: "custom",
    apiKeys: document.getElementById("custom_api_keys").value
                  .split('\n').filter(line => line.trim() !== ""),
    endpoint: document.getElementById("custom_endpoint").value,
    customModel: document.getElementById("custom_model").value
  };
  store.put(settingsToSave);
  // <- –¥–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
  customSettings.apiKeys    = settingsToSave.apiKeys;
  customSettings.endpoint   = settingsToSave.endpoint;
  customSettings.customModel= settingsToSave.customModel;
}

// 2) –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ IndexedDB
function loadCustomSettings() {
  if (!db) return;
  const transaction = db.transaction(["chtbtsettings"], "readonly");
  const store = transaction.objectStore("chtbtsettings");
  const request = store.get("custom");
  request.onsuccess = function(e) {
    const result = e.target.result;
    if (result) {
      customSettings.apiKeys     = result.apiKeys;
      customSettings.endpoint    = result.endpoint;
      customSettings.customModel = result.customModel;
      // —Å—Ç–∞–≤–∏–º —Ä–µ–∂–∏–º ¬´–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö¬ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      customSettings.useCustom = true;
      document.getElementById("custom_settings_checkbox").checked = true;
      updateFieldLocks();
      // –∞ —Ñ–æ—Ä–º—É —Ç–æ–∂–µ –∑–∞–ø–æ–ª–Ω—è–µ–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      document.getElementById("custom_api_keys").value = result.apiKeys.join('\n');
      document.getElementById("custom_endpoint").value = result.endpoint;
      document.getElementById("custom_model").value = result.customModel;
    }
  };
  request.onerror = function(e) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫", e);
  };
}

    function loadCustomSettings() {
      if (!db) return;
      const transaction = db.transaction(["chtbtsettings"], "readonly");
      const store = transaction.objectStore("chtbtsettings");
      const request = store.get("custom");
      request.onsuccess = function(e) {
        const result = e.target.result;
        if (result) {
          customSettings.apiKeys = result.apiKeys;
          customSettings.endpoint = result.endpoint;
          customSettings.customModel = result.customModel;
          document.getElementById("custom_api_keys").value = customSettings.apiKeys.join('\n');
          document.getElementById("custom_endpoint").value = customSettings.endpoint;
          document.getElementById("custom_model").value = customSettings.customModel;
        }
      };
      request.onerror = function(e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫", e);
      };
    }
    // ------------------- –ö–æ–Ω–µ—Ü IndexedDB -------------------

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    function updateChat() {
      const chatContainer = document.getElementById("chat-container");
      chatContainer.innerHTML = "";
      conversation.forEach((msg, index) => {
        if (msg.role === "system") return;
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        if (msg.role === "assistant") {
          if (settings.use_markdown) {
            messageDiv.innerHTML = marked.parse(msg.content);
          } else {
            messageDiv.textContent = msg.content;
          }
          messageDiv.classList.add("assistant");
          if (index === conversation.length - 1) {
            const regenButton = document.createElement("button");
            regenButton.classList.add("regenerate-button");
            regenButton.textContent = "–∑–∞–Ω–æ–≤–æ";
            regenButton.addEventListener("click", regenerateLastResponse);
            messageDiv.appendChild(regenButton);
          }
        } else {
          messageDiv.textContent = msg.content;
          messageDiv.classList.add("user");
        }
        chatContainer.appendChild(messageDiv);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function goBack() {
      window.location.href = "glist.html";
    }

    function showRetryIndicator() {
      const indicatorContainer = document.getElementById("retry-indicator");
      const line = document.createElement("div");
      line.classList.add("retry-line");
      indicatorContainer.appendChild(line);
    }
    
    function clearRetryIndicator() {
      document.getElementById("retry-indicator").innerHTML = "";
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
    async function sendChatRequestWithRetry(messages) {
      let attempt = 1;
      while (true) {
        try {
          let apiKeysToUse = defaultApiKeys;
          let endpoint = "https://openrouter.ai/api/v1/chat/completions";
          let modelForRequest = settings.model;
          if (customSettings.useCustom) {
            if (customSettings.apiKeys.length > 0) {
              apiKeysToUse = customSettings.apiKeys;
            }
            endpoint = customSettings.endpoint;
            modelForRequest = customSettings.customModel;
          }
          const randomKey = apiKeysToUse[Math.floor(Math.random() * apiKeysToUse.length)];
          const response = await fetch(endpoint, {
            method: "POST",
            mode: "cors",
            headers: {
              "Authorization": "Bearer " + randomKey,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              "model": modelForRequest,
              "messages": customSettings.useCustom 
                          ? messages.filter(msg => msg.role !== "system")
                          : (settings.assistantType !== "pure" 
                              ? [ (settings.assistantType === "native" ? nativeSystemMessage : evilSystemMessage), ...messages.filter(msg => msg.role !== "system") ]
                              : messages.filter(msg => msg.role !== "system") ),
              "top_p": settings.top_p,
              "temperature": settings.temperature,
              "repetition_penalty": settings.repetition_penalty
            })
          });
          if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + response.statusText);
          }
          const data = await response.json();
          if (data.choices && data.choices[0] && data.choices[0].message.content) {
            clearRetryIndicator();
            return data.choices[0].message.content;
          } else {
            showRetryIndicator();
            attempt++;
            await new Promise(res => setTimeout(res, 500));
            continue;
          }
        } catch (error) {
          showRetryIndicator();
          attempt++;
          await new Promise(res => setTimeout(res, 500));
        }
      }
    }

    function trimConversation() {
      while (conversation.length > 20) {
        conversation.shift();
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    async function sendRequest() {
      let messagesToSend = conversation.filter(msg => msg.role !== "system");
      if (!customSettings.useCustom && settings.assistantType !== "pure") {
        const sysMsg = settings.assistantType === "native" ? nativeSystemMessage : evilSystemMessage;
        messagesToSend.unshift(sysMsg);
      }
      const responseText = await sendChatRequestWithRetry(messagesToSend);
      conversation.push({role: "assistant", content: responseText});
      updateChat();
    }

    document.getElementById("chatForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      try {
        const input = document.getElementById("messageInput");
        const userMessage = input.value.trim();
        if (!userMessage) return;
        conversation.push({role: "user", content: userMessage});
        updateChat();
        input.value = "";
        input.blur();
        await sendRequest();
      } catch (outerError) {
        console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã: ", outerError);
      }
    });

    async function regenerateLastResponse() {
      if (conversation.length > 0 && conversation[conversation.length - 1].role === "assistant") {
        conversation.pop();
        updateChat();
        await sendRequest();
      }
    }

    const messageInput = document.getElementById("messageInput");
    const chatForm = document.getElementById("chatForm");
    messageInput.addEventListener("focus", function () {
      chatForm.classList.add("active");
      setTimeout(() => {
        this.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 300);
    });
    messageInput.addEventListener("blur", function () {
      chatForm.classList.remove("active");
    });

    function updateSettingDisplays() {
      document.getElementById("top_p_val").textContent = document.getElementById("top_p").value;
      document.getElementById("temperature_val").textContent = document.getElementById("temperature").value;
      document.getElementById("repetition_val").textContent = document.getElementById("repetition_penalty").value;
    }

    document.getElementById("settingsButton").addEventListener("click", () => {
      document.getElementById("settings-modal").style.display = "flex";
    });
    document.getElementById("close-settings").addEventListener("click", () => {
      document.getElementById("settings-modal").style.display = "none";
      if (customSettings.useCustom) saveCustomSettings();
    });

    document.getElementById("top_p").addEventListener("input", function() {
      settings.top_p = parseFloat(this.value);
      updateSettingDisplays();
    });
    document.getElementById("temperature").addEventListener("input", function() {
      settings.temperature = parseFloat(this.value);
      updateSettingDisplays();
    });
    document.getElementById("repetition_penalty").addEventListener("input", function() {
      settings.repetition_penalty = parseFloat(this.value);
      updateSettingDisplays();
    });

    function saveConversation() {
      if (!db) return;
      const transaction = db.transaction(["conversations"], "readwrite");
      const store = transaction.objectStore("conversations");
      const conversationToSave = {
        timestamp: Date.now(),
        conversation: conversation,
        snippet: conversation[conversation.length - 1].content.substring(0, 50)
      };
      const request = store.add(conversationToSave);
      request.onsuccess = function() {
        console.log("–ë–µ—Å–µ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
        loadSavedConversations();
      };
      request.onerror = function(e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–µ—Å–µ–¥—ã", e);
      };
    }

    function loadSavedConversations() {
      if (!db) return;
      const transaction = db.transaction(["conversations"], "readonly");
      const store = transaction.objectStore("conversations");
      const request = store.getAll();
      request.onsuccess = function(e) {
        const conversations = e.target.result;
        populateConversationsIframe(conversations);
      };
      request.onerror = function(e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–µ—Å–µ–¥", e);
      };
    }

    function populateConversationsIframe(conversations) {
      const iframe = document.getElementById("savedConversationsFrame");
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      let html = `<style>
                    body { font-family: sans-serif; padding: 10px; margin: 0; }
                    .conv { border-bottom: 1px solid #ccc; padding: 5px 0; display: flex; justify-content: space-between; align-items: center; }
                    .conv span { font-size: 14px; }
                    .conv button { font-size: 12px; margin-left: 5px; }
                  </style>`;
      html += "<div>";
      conversations.forEach(conv => {
        html += `<div class="conv">
                   <span>${new Date(conv.timestamp).toLocaleString()} - ${conv.snippet}...</span>
                   <div>
                     <button onclick="parent.loadConversation(${conv.id})">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                     <button onclick="parent.deleteConversation(${conv.id})">–£–¥–∞–ª–∏—Ç—å</button>
                   </div>
                 </div>`;
      });
      html += "</div>";
      doc.body.innerHTML = html;
    }

    function loadConversation(id) {
      if (!db) return;
      const transaction = db.transaction(["conversations"], "readonly");
      const store = transaction.objectStore("conversations");
      const request = store.get(id);
      request.onsuccess = function(e) {
        const conv = e.target.result;
        if (conv) {
          conversation = conv.conversation;
          updateChat();
        }
      };
      request.onerror = function(e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–µ—Å–µ–¥—ã", e);
      };
    }

    function deleteConversation(id) {
      if (!db) return;
      const transaction = db.transaction(["conversations"], "readwrite");
      const store = transaction.objectStore("conversations");
      const request = store.delete(id);
      request.onsuccess = function(e) {
        loadSavedConversations();
      };
      request.onerror = function(e) {
        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–µ—Å–µ–¥—ã", e);
      };
    }

    document.getElementById("saveConversationButton").addEventListener("click", function() {
      saveConversation();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexedDB
    initDB();
  </script>


<script>
(function(){
  const SELECTORS = {
    form:      '#chatForm',
    input:     '#messageInput',
    container: '#chat-container',
    assistant: '.message.assistant'
  };

  let JSenabled = true;
  let lastEvalText = null; // —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ eval'–Ω—É—Ç–æ–≥–æ –±–ª–æ–∫–∞

  const form      = document.querySelector(SELECTORS.form);
  const input     = document.querySelector(SELECTORS.input);
  const container = document.querySelector(SELECTORS.container);

  if (!form || !input || !container) {
    console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å SELECTORS.');
    return;
  }

  // –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ "/!"
  form.addEventListener('submit', () => {
    JSenabled = !input.value.includes('/!');
  });

  // –Ω–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —á–∞—Ç–∞
  const observer = new MutationObserver(() => {
    const all = container.querySelectorAll(SELECTORS.assistant);
    const last = all[all.length - 1];
    if (!last) return;

    const codeToEval = extractCodeFrom(last);
    if (!codeToEval) return;

    // –µ—Å–ª–∏ –∫–æ–¥ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è ‚Äî –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º
    if (codeToEval === lastEvalText) return;
    lastEvalText = codeToEval;

    if (!JSenabled) return;

    try {
      const clean = codeToEval
        .replace(/^["'`]+|["'`]+$/g, '')
        .replace(/\\n/g, '\n')
        .replace(/" \+ "/g, '')
        .replace(/\\"/g, '"')
        .replace(/\\'/g, "'")
        .trim();

      new Function(clean)(); // –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ eval
    } catch (e) {
      alert("–û—à–∏–±–∫–∞. –ë–µ–∑ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.");
    }
  });

  observer.observe(container, {
    childList: true,
    subtree: true
  });

  // –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ –º–µ–∂–¥—É ¬©...¬©
  function extractCodeFrom(root) {
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
    let textNode;
    while (textNode = walker.nextNode()) {
      const txt = textNode.textContent;
      const match = txt.match(/¬©([\s\S]+?)¬©/);
      if (match) {
        // –≤—ã—Ä–µ–∑–∞–µ–º –∫–æ–¥ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        textNode.textContent = txt.replace(match[0], '');
        return match[1];
      }
    }
    return null;
  }

  console.log('üß® Eval-–∫–æ–Ω—Ç—Ä–æ–ª—å: —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–¥–∏–Ω —Ä–∞–∑, –±–µ–∑ –æ—à–∏–±–æ–∫ –Ω–∞—Ä—É–∂—É.');
})();
</script>






</body>
</html>
