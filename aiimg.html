<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>–≤–æ—Å—Ö–∏—Ç–ò–ò—Ç–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–ò–ò–Ω–∫–∏</title>
<style>
:root{
  --bg:#05050a;
  --panel:#0c0c12;
  --accent1:#ff4d6d;
  --accent2:#9b5cff;
  --accent3:#ffcf4d;
  --muted:#9aa3bf;
}
html,body{
  height:100%;
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#040406,#0b0b10);
  font-family:Inter, Roboto, Arial, sans-serif;
  color:#eef5ff;
  -webkit-font-smoothing:antialiased;
  overflow:hidden; /* –∑–∞–ø—Ä–µ—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
  touch-action:none;
}

/* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.wrap{
  height:100vh;
  box-sizing:border-box;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
}

/* BACK –≤ —É–≥–ª—É (–æ—Ç–¥–µ–ª—å–Ω–æ) */
.back{
  position:fixed;
  left:10px;
  top:10px;
  z-index:50;
  width:44px;
  height:44px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.04);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color:var(--accent2);
  font-weight:800;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 6px 20px rgba(0,0,0,0.5);
}

/* –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–µ–≤—å—é (—Å—Ç–∞—Ç–∏—á–Ω–∞, –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è) */
.preview-card{
  background:var(--panel);
  border-radius:14px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.035);
  box-shadow:0 10px 40px rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  height:calc(100vh - 360px);
}

/* –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é */
#outImg{
  max-width:100%;
  max-height:100%;
  border-radius:8px;
  object-fit:cover;
}

/* –ë–û–õ–¨–®–û–ï –ø–æ–ª–µ –≤–≤–æ–¥–∞ (–≤ –ø–æ—Ç–æ–∫–µ) */
.input-wrap{
  position:relative;
  margin-top:8px;
}

/* textarea –≤ –ø–æ—Ç–æ–∫–µ */
#prompt{
  width:100%;
  min-height:96px;
  max-height:46vh;
  box-sizing:border-box;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.04);
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  color:inherit;
  font-size:16px;
  line-height:1.35;
  resize:none;
  overflow:auto;
  outline:none;
  transition: transform 260ms cubic-bezier(.2,.9,.28,1), width 200ms ease, height 200ms ease;
  z-index:10;
}

/* textarea –≤ ¬´–ø–ª–∞–≤–∞—é—â–µ–º¬ª —Å–æ—Å—Ç–æ—è–Ω–∏–∏: —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –≤ —Å–µ—Ä–µ–¥–∏–Ω—É —ç–∫—Ä–∞–Ω–∞.
   –¢–æ–ª—å–∫–æ —Å–∞–º–æ –ø–æ–ª–µ –º–µ–Ω—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ. */
#prompt.floating{
  position:fixed;
  left:12px;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  width:calc(100% - 24px);
  max-height:60vh;
  height:40vh;
  box-shadow:0 20px 60px rgba(0,0,0,0.7);
  border-radius:14px;
  z-index:100;
}

/* –õ–æ–≥-–ø–∞–Ω–µ–ª—å: —Å—Ç–∞—Ç—É—Å, –∂—É—Ä–Ω–∞–ª, –∫–Ω–æ–ø–∫–∏ */
.log-panel{
  margin-top:8px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  justify-content:space-between;
}

/* –∫–æ–ª–æ–Ω–∫–∞ –ª–æ–≥–∞ */
.log-col{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* —Å—Ç–∞—Ç—É—Å */
.status-line{
  font-size:13px;
  color:var(--muted);
}

/* –∂—É—Ä–Ω–∞–ª ‚Äî –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–ª–æ–∫ */
.journal{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border:1px solid rgba(255,255,255,0.03);
  border-radius:10px;
  padding:8px;
  height:96px;
  overflow:auto; /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∫—Ä–æ–ª–ª —Ä–∞–∑—Ä–µ—à—ë–Ω */
  font-size:13px;
  color:var(--muted);
}

/* –∑–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞ */
.log-entry{margin-bottom:6px;}
.log-entry.info{color:var(--muted);}
.log-entry.ok{color:var(--accent2);}
.log-entry.err{color:var(--accent1); background:rgba(255,77,109,0.04); padding:6px; border-radius:6px; border:1px solid rgba(255,77,109,0.06);}

/* –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ */
.controls{
  display:flex;
  gap:8px;
  align-items:center;
}

/* —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
.button{
  border-radius:12px;
  padding:10px 12px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.btn-gen{background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#08060a;}
.icon-btn{width:52px;height:52px;border-radius:12px;border:none;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.03);}

/* —Å–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
.hidden{display:none;}

@media (max-width:520px){
  #prompt{min-height:110px}
  .journal{height:88px}
}
</style>
</head>
<body>
<div class="wrap" id="wrap" aria-label="–≤–æ—Å—Ö–∏—Ç–ò–ò—Ç–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–ò–ò–Ω–∫–∏">
  <button class="back" id="backBtn" title="–ù–∞–∑–∞–¥">‚Üê</button>

  <div class="preview-card" id="previewCard" aria-hidden="false">
    <img id="outImg" src="button.png" alt="–ù–µ —Ä–∏—Å—É–π—Ç–µ –ø–∏—Å—å–∫–∏ –¥–µ—Ç—å–∫–∏ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞" />
  </div>

  <div class="input-wrap">
    <textarea id="prompt" placeholder="–û–ø–∏—à–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∑–¥–µ—Å—å..." rows="4" aria-label="–ü—Ä–æ–º–ø—Ç"></textarea>

    <div class="log-panel" role="region" aria-label="–ñ—É—Ä–Ω–∞–ª –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
      <div class="log-col">
        <div class="status-line" id="statusLine">–°—Ç–∞—Ç—É—Å: [0], –≤–≤–æ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç.</div>
        <div class="journal" id="journal" aria-live="polite"></div>
      </div>

      <div class="controls">
        <button class="button btn-gen" id="genBtn">–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>
        <button class="icon-btn" id="copyImageBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ" disabled>‚úÇ</button>
        <button class="icon-btn" id="copyLinkBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É" disabled>üîó</button>
        <button class="icon-btn" id="keysRefreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å –∫–ª—é—á–∏">‚ôª</button>
      </div>
    </div>
  </div>
</div>

<script>


/* --- –∫–æ–Ω—Ñ–∏–≥ --- */
const KEYS_URLS = [
  'https://raw.githubusercontent.com/Vaneyn/glistnet/refs/heads/main/freePOE.txt'
  
];
const IMAGE_MODEL = 'gpt-image-1-mini';
const EXTRA_BODY = { aspect: "1:1", quality: "low" };

/* --- DOM --- */
const backBtn = document.getElementById('backBtn');
const promptEl = document.getElementById('prompt');
const previewCard = document.getElementById('previewCard');
const outImg = document.getElementById('outImg');
const statusLine = document.getElementById('statusLine');
const journal = document.getElementById('journal');
const genBtn = document.getElementById('genBtn');
const copyImageBtn = document.getElementById('copyImageBtn');
const copyLinkBtn = document.getElementById('copyLinkBtn');
const keysRefreshBtn = document.getElementById('keysRefreshBtn');

let decryptedKeys = [];
let lastImageSrc = null;         // –º–æ–∂–µ—Ç –±—ã—Ç—å data: | http(s) | blob-url
let lastImageOriginalUrl = null; // –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –æ—Ç Poe –¥–∞–ª –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë —Ç—É—Ç (http/https)
let lastImageBlob = null;

/* --- –Ω–µ–±–æ–ª—å—à–∏–µ —Ö–µ–ª–ø–µ—Ä—ã UI --- */
function setStatusCount(n){
  statusLine.textContent = '–°—Ç–∞—Ç—É—Å: [' + (Number.isInteger(n)?n:0) + '], –≤–≤–æ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç.';
}
function appendLog(text, level='info'){ // level: info / ok / err
  const div = document.createElement('div');
  div.className = 'log-entry ' + (level==='err'?'err': level==='ok'?'ok':'info');
  div.textContent = text;
  journal.appendChild(div);
  // –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –≤–Ω—É—Ç—Ä–∏ journal (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∫—Ä–æ–ª–ª —Ä–∞–∑—Ä–µ—à—ë–Ω)
  journal.scrollTop = journal.scrollHeight;
}
function clearLogs(){ journal.innerHTML = ''; }

function decryptLine(line){
  const a='a'.charCodeAt(0), z='z'.charCodeAt(0), A='A'.charCodeAt(0), Z='Z'.charCodeAt(0);
  let out='';
  for(const ch of line){
    const code = ch.charCodeAt(0);
    if(code >= A && code <= Z){
      const shifted = ((code - A - 3) % 26 + 26) % 26 + A;
      const reflected = A + (Z - shifted);
      out += String.fromCharCode(reflected);
    } else if(code >= a && code <= z){
      const shifted = ((code - a - 3) % 26 + 26) % 26 + a;
      const reflected = a + (z - shifted);
      out += String.fromCharCode(reflected);
    } else out += ch;
  }
  return out;
}


async function fetchAndDecryptKeys(){
  setStatusCount(0);
  appendLog('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');
  decryptedKeys = [];
  for(const url of KEYS_URLS){
    try{
      const resp = await fetch(url, {cache:'no-store'});
      if(!resp.ok){
        appendLog('–ò—Å—Ç–æ—á–Ω–∏–∫ –∫—É–∫—É: ' + url + ' (' + resp.status + ')', 'err');
        continue;
      }
      const txt = await resp.text();
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const keys = lines.map(decryptLine).filter(k => k && k.length > 8);
      if(keys.length){
        decryptedKeys = keys;
        appendLog('–ö–ª—é—á–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ' + keys.length + ' —à—Ç.', 'ok');
        setStatusCount(keys.length);
        return;
      } else {
        appendLog('–ò—Å—Ç–æ—á–Ω–∏–∫ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ, –Ω–æ –Ω–µ—Ç—É –Ω–∏—á–æ: ' + url, 'err');
      }
    }catch(e){
      appendLog('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á–∏ —Å ' + url + ' ‚Äî —Å–µ—Ç—å/–æ—à–∏–±–∫–∞.', 'err');
      continue;
    }
  }
  appendLog('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏—Ö–µ—Ä–∞ –Ω–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.', 'err');
  setStatusCount(0);
}

/* --- –≤—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–ª—é—á–∞ --- */
function pickRandomKey(excluded = new Set()){
  if(!decryptedKeys || decryptedKeys.length === 0) return undefined;
  const idxs = [];
  for(let i=0;i<decryptedKeys.length;i++) if(!excluded.has(i)) idxs.push(i);
  if(idxs.length === 0) return undefined;
  const idx = idxs[Math.floor(Math.random()*idxs.length)];
  return {key: decryptedKeys[idx], index: idx};
}

/* --- –ø–∞—Ä—Å–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–∏—â–µ—Ç data URL, –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É, –∏–ª–∏ base64) --- */
function extractImageFromMessage(msg){
  try{
    if(!msg) return null;
    if(typeof msg === 'object'){
      const fields = ['b64_json','b64','base64','image','images','data','url','output'];
      for(const f of fields) if(msg[f]){
        const v = msg[f];
        if(typeof v === 'string') return v;
        if(Array.isArray(v) && v.length) return typeof v[0] === 'string' ? v[0] : (v[0].b64_json||v[0].url||null);
        if(typeof v === 'object'){ if(v.b64_json) return v.b64_json; if(v.url) return v.url; }
      }
    }
    if(typeof msg === 'string'){
      const dataMatch = msg.match(/data:image\/[A-Za-z0-9.+-]+;base64,[A-Za-z0-9+/=]+/);
      if(dataMatch) return dataMatch[0];
      const urlMatch = msg.match(/https?:\/\/[^\s'"]+\.(png|jpg|jpeg|webp|gif)/i);
      if(urlMatch) return urlMatch[0];
      const b64Match = msg.match(/([A-Za-z0-9+/]{200,}={0,2})/);
      if(b64Match && (b64Match[1].length > 300 || b64Match[1].startsWith('iVBOR'))) return b64Match[1];
      const md = msg.match(/!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/i);
      if(md) return md[1];
      try{ const parsed = JSON.parse(msg); return extractImageFromMessage(parsed); }catch(e){}
    }
  }catch(e){}
  return null;
}
function normalizeToSrc(candidate){
  if(!candidate) return null;
  if(candidate.startsWith('data:image')) return candidate;
  if(candidate.startsWith('http')) return candidate;
  return 'data:image/png;base64,' + candidate;
}

/* --- –∑–∞–ø—Ä–æ—Å –∫ Poe —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º --- */
async function requestWithKey(key, prompt){
  const payload = { model: IMAGE_MODEL, messages:[{role:'user', content: prompt}], extra_body: EXTRA_BODY, stream:false };
  try{
    const resp = await fetch('https://api.poe.com/v1/chat/completions', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer ' + key },
      body: JSON.stringify(payload)
    });
    const txt = await resp.text();
    if(!resp.ok) return { ok:false, http:resp.status, body: txt };
    let data=null; try{ data = JSON.parse(txt); }catch(e){}
    return { ok:true, data };
  }catch(e){
    return { ok:false, http:null, body: String(e) };
  }
}

/* --- –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å –ø–µ—Ä–µ–±–æ—Ä–æ–º –∫–ª—é—á–µ–π –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö --- */
async function generateImage(prompt){
  clearLogs();
  appendLog('–°—Ç–∞—Ä—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...', 'info');
  lastImageSrc = null; lastImageOriginalUrl = null; lastImageBlob = null;
  copyImageBtn.disabled = true; copyLinkBtn.disabled = true;
  if(!prompt || !prompt.trim()){
    appendLog('–ü—Ä–æ–º–ø—Ç –ø—É—Å—Ç–æ–π ‚Äî –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç.', 'err'); return;
  }
  if(!decryptedKeys || decryptedKeys.length === 0){
    appendLog('–ö–ª—é—á–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'err'); return;
  }
  setStatusCount(decryptedKeys.length);

  const tried = new Set();
  let lastProblem = null;
  for(let attempt = 0; attempt < decryptedKeys.length; attempt++){
    const pick = pickRandomKey(tried);
    if(!pick) break;
    tried.add(pick.index);
    appendLog('–ë—ä—Ö—Ü–π' + (attempt+1) + ' –∫–ª—é—á ‚Ññ' + (pick.index+1) + '...', 'info');
    const res = await requestWithKey(pick.key, prompt);
    if(!res.ok){
      appendLog('–°–µ—Ä–≤–µ—Ä –¥–∞–ª –æ—Ç–≤–µ—Ç: ' + (res.http || 'network') + ' ‚Äî ' + String(res.body).slice(0,200), 'err');
      lastProblem = '–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-OK';
      continue;
    }
    try{
      const choice = res.data && res.data.choices && res.data.choices[0];
      if(!choice || !choice.message){
        appendLog('–ù–µ–ø—Ä–∏–≤—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–Ω–µ—Ç message).', 'err');
        lastProblem = '–Ω–µ—Ç message';
        continue;
      }
      const msg = choice.message.content;
      let candidate = extractImageFromMessage(msg);
      // tool_calls fallbacks
      if(!candidate && choice.message.tool_calls && choice.message.tool_calls.length){
        try{
          const tc = choice.message.tool_calls[0];
          const parsed = (typeof tc.arguments === 'string') ? JSON.parse(tc.arguments) : tc.arguments;
          candidate = extractImageFromMessage(parsed);
        }catch(e){}
      }
      if(!candidate){
        const text = typeof msg === 'string' ? msg : JSON.stringify(msg);
        const mdMatch = text.match(/!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/i);
        if(mdMatch) candidate = mdMatch[1];
      }
      if(!candidate){
        appendLog('–í –æ—Ç–≤–µ—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.', 'err');
        lastProblem = '–Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞';
        continue;
      }

      // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
      const normalized = normalizeToSrc(candidate);

      // –µ—Å–ª–∏ —ç—Ç–æ –≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞, —Å–æ—Ö—Ä–∞–Ω–∏–º –µ—ë –∫–∞–∫ original
      if(normalized.startsWith('http')){
        lastImageOriginalUrl = normalized;
        // –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å blob –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä
        try{
          const r = await fetch(normalized, {mode:'cors'});
          if(r.ok){
            const blob = await r.blob();
            lastImageBlob = blob;
            // –∏—Å–ø–æ–ª—å–∑—É–µ–º blob-url –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ http –≤ UI)
            lastImageSrc = URL.createObjectURL(blob);
          } else {
            // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å blob ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É (–±–µ–∑ –ø–æ–∫–∞–∑–∞ –µ—ë –≤ UI)
            lastImageBlob = null;
            lastImageSrc = normalized;
          }
        }catch(e){
          lastImageBlob = null;
          lastImageSrc = normalized;
        }
      } else {
        // data URI => –ø–æ–∫–∞–∂–µ–º –ø—Ä—è–º–æ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º blob, –Ω–æ –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–∏ –Ω–µ –±—É–¥–µ—Ç
        lastImageOriginalUrl = null;
        lastImageSrc = normalized;
        try{ const r = await fetch(normalized); lastImageBlob = await r.blob(); }catch(e){ lastImageBlob = null; }
      }

      // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–≤—å—é (–≤ UI –º—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π http URL, —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫—É)
      outImg.src = lastImageSrc;
      appendLog('–û–æ–æ –º–æ—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ :‚ü© (–∫–ª—é—á ‚Ññ' + (pick.index+1) + ').', 'ok');
      copyImageBtn.disabled = false;
      // –∫–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å –≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞
      copyLinkBtn.disabled = !lastImageOriginalUrl;
      setStatusCount(decryptedKeys.length);
      return;
    }catch(e){
      appendLog('–ü—Ä–æ–±–ª–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ (–ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á).', 'err');
      lastProblem = '–æ–±—Ä–∞–±–æ—Ç–∫–∞';
      continue;
    }
  }

  appendLog('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: ' + (lastProblem || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞'), 'err');
  setStatusCount(decryptedKeys.length);
}

/* --- –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä --- */
async function copyImageToClipboard(){
  if(!lastImageBlob && !lastImageSrc){
    appendLog('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.', 'err'); return;
  }
  try{
    let blob = lastImageBlob;
    if(!blob){
      const r = await fetch(lastImageSrc);
      blob = await r.blob();
    }
    if(navigator.clipboard && window.ClipboardItem){
      const item = new ClipboardItem({ [blob.type]: blob });
      await navigator.clipboard.write([item]);
      appendLog('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä.', 'ok');
      return;
    }
    // fallback: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –ø–ª–∞–Ω (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º URL)
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'voshhit.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    appendLog('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äî –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–∞—á–∞–Ω–æ (fallback).', 'info');
  }catch(e){
    appendLog('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ' + String(e).slice(0,200), 'err');
  }
}

/* --- –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å) --- */
async function copyLinkToClipboard(){
  if(!lastImageOriginalUrl){
    appendLog('–í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'err');
    return;
  }
  try{
    await navigator.clipboard.writeText(lastImageOriginalUrl);
    appendLog('–í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä.', 'ok');
  }catch(e){
    // fallback
    try{
      const ta = document.createElement('textarea');
      ta.value = lastImageOriginalUrl;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      appendLog('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (fallback).', 'ok');
    }catch(e2){
      appendLog('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É.', 'err');
    }
  }
}

/* --- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI --- */
backBtn.addEventListener('click', ()=>{ try{ location.href = 'glist.html'; }catch(e){} });

promptEl.addEventListener('focus', ()=>{ promptEl.classList.add('floating'); appendLog('–ü–æ–ª–µ –≤–≤–æ–¥–∞ –∞–∫—Ç–∏–≤–Ω–æ ‚Äî –ø–æ–¥–Ω—è—Ç–æ.', 'info'); });
promptEl.addEventListener('blur', ()=>{ promptEl.classList.remove('floating'); appendLog('–ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–Ω—è—Ç–æ —Å —Ñ–æ–∫—É—Å–∞.', 'info'); });

/* autoresize textarea */
function autosize(){
  promptEl.style.height = 'auto';
  const max = window.innerHeight * 0.6;
  promptEl.style.height = Math.min(max, promptEl.scrollHeight) + 'px';
}
promptEl.addEventListener('input', ()=>{ autosize(); });

genBtn.addEventListener('click', async ()=>{ await generateImage(promptEl.value); });
copyImageBtn.addEventListener('click', async ()=>{ await copyImageToClipboard(); });
copyLinkBtn.addEventListener('click', async ()=>{ await copyLinkToClipboard(); });
keysRefreshBtn.addEventListener('click', async ()=>{ appendLog('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π –ø–æ –∑–∞–ø—Ä–æ—Å—É...', 'info'); await fetchAndDecryptKeys(); });

/* --- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è --- */
(async function init(){
  setStatusCount(0);
  autosize();
  appendLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...', 'info');
  await fetchAndDecryptKeys();
  setStatusCount(decryptedKeys.length);
  appendLog('–ì–æ—Ç–æ–≤–æ.', 'info');
})();
</script>
</body>
</html>
