<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kufar Parser + AI</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Unbounded:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f14; --surface:#161a22; --border:#252b38;
  --accent:#f5c842; --accent2:#42c8f5; --text:#e4e8f0;
  --muted:#6b7689; --danger:#f54242; --good:#42f58a;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;overflow-x:hidden}

/* HEADER */
header{border-bottom:2px solid var(--accent);padding:13px 18px;display:flex;align-items:center;gap:12px;background:var(--surface);position:sticky;top:0;z-index:100}
.logo{font-family:'Unbounded',sans-serif;font-weight:900;font-size:17px;letter-spacing:-1px;color:var(--accent);white-space:nowrap}
.logo span{color:var(--accent2)}
.header-tag{background:var(--border);color:var(--muted);font-size:9px;padding:3px 7px;border-radius:2px;letter-spacing:2px;text-transform:uppercase}
.header-count{margin-left:auto;font-size:11px;color:var(--muted);white-space:nowrap}
.header-count strong{color:var(--accent)}
.btn-debug{background:rgba(245,66,66,.12);border:1px solid rgba(245,66,66,.35);color:#f54242;font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 11px;border-radius:4px;cursor:pointer;transition:background .15s;white-space:nowrap}
.btn-debug:hover{background:rgba(245,66,66,.22)}
.btn-filters-toggle{display:none;background:var(--border);border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;padding:8px 13px;border-radius:4px;cursor:pointer;white-space:nowrap}

/* LAYOUT */
.layout{display:grid;grid-template-columns:295px 1fr;min-height:calc(100vh - 51px)}

/* SIDEBAR */
aside{background:var(--surface);border-right:1px solid var(--border);padding:18px 15px;display:flex;flex-direction:column;gap:15px;position:sticky;top:51px;height:calc(100vh - 51px);overflow-y:auto;transition:transform .3s ease}
.section-label{font-size:9px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:5px}
.field-group{display:flex;flex-direction:column;gap:5px}
label{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
input,select{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:10px 11px;border-radius:4px;outline:none;transition:border-color .15s;width:100%}
input:focus,select:focus{border-color:var(--accent)}
input::placeholder{color:var(--muted)}
select option{background:var(--surface)}
.price-row{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.btn-search{background:var(--accent);color:#0d0f14;border:none;padding:12px;font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;cursor:pointer;border-radius:4px;transition:background .15s;width:100%;text-transform:uppercase}
.btn-search:hover:not(:disabled){background:#ffd95a}
.btn-search:disabled{opacity:.5;cursor:not-allowed}
.btn-ai{background:transparent;color:var(--good);border:1px solid var(--good);padding:11px;font-family:'Unbounded',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer;border-radius:4px;transition:background .15s,opacity .15s;width:100%;text-transform:uppercase}
.btn-ai:hover:not(:disabled){background:rgba(66,245,138,.1)}
.btn-ai:disabled{opacity:.4;cursor:not-allowed}
.btn-export{background:transparent;color:var(--accent2);border:1px solid var(--accent2);padding:9px;font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;border-radius:4px;transition:background .15s;width:100%}
.btn-export:hover{background:rgba(66,200,245,.1)}
.divider{border:none;border-top:1px solid var(--border)}
.proxy-note{background:rgba(245,200,66,.07);border:1px solid rgba(245,200,66,.2);color:var(--muted);font-size:10px;padding:8px 10px;border-radius:4px;line-height:1.6}
.proxy-note strong{color:var(--accent)}

/* AI STATUS */
.ai-status-box{background:rgba(66,245,138,.06);border:1px solid rgba(66,245,138,.2);border-radius:4px;padding:9px 11px;font-size:10px;color:var(--good);line-height:1.7;display:none}
.ai-status-box.active{display:block}
.ai-progress{background:var(--border);border-radius:2px;height:3px;margin-top:7px;overflow:hidden}
.ai-progress-fill{height:100%;background:var(--good);width:0%;transition:width .4s ease;border-radius:2px}

/* MAIN */
main{padding:18px 15px;overflow-y:auto;height:calc(100vh - 51px)}
.status-bar{display:flex;align-items:center;gap:9px;margin-bottom:14px;font-size:11px;color:var(--muted);flex-wrap:wrap}
.status-bar .count{color:var(--accent);font-weight:700;font-size:15px}
.ai-sort-btn{margin-left:auto;background:transparent;border:1px solid rgba(66,245,138,.4);color:var(--good);font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 11px;border-radius:3px;cursor:pointer}
.ai-sort-btn:hover{background:rgba(66,245,138,.1)}
.ai-sort-btn.active{background:rgba(66,245,138,.2);border-color:var(--good)}

/* GRID */
.results-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:13px}

/* CARD */
.card{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;text-decoration:none;display:block;transition:border-color .15s,transform .15s;animation:fadeUp .25s ease;position:relative}
.card:hover{border-color:var(--accent);transform:translateY(-2px)}
.card.deal-hot{border-color:rgba(66,245,138,.7)!important;box-shadow:0 0 12px rgba(66,245,138,.15)}
.card.deal-good{border-color:rgba(66,245,138,.4)!important}
.card.deal-bad{border-color:rgba(245,66,66,.3)!important}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* RATE BADGE */
.rate-badge{position:absolute;top:8px;right:8px;font-family:'Unbounded',sans-serif;font-size:10px;font-weight:700;padding:3px 7px;border-radius:3px;z-index:5;backdrop-filter:blur(4px);display:none}
.rate-badge.vis{display:block}
.rate-badge.rate-hot{background:rgba(66,245,138,.92);color:#0d0f14}
.rate-badge.rate-good{background:rgba(66,245,138,.65);color:#0d0f14}
.rate-badge.rate-ok{background:rgba(245,200,66,.85);color:#0d0f14}
.rate-badge.rate-bad{background:rgba(245,66,66,.8);color:#fff}
.rate-badge.rate-loading{background:rgba(66,200,245,.3);color:var(--accent2);animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.45}50%{opacity:1}}

.card-img{width:100%;height:165px;object-fit:cover;display:block;background:var(--border)}
.card-no-img{width:100%;height:165px;background:var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:10px;letter-spacing:2px}
.card-body{padding:11px 13px}
.card-price{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700;color:var(--accent);margin-bottom:5px}
.card-title{font-size:12px;color:var(--text);line-height:1.5;margin-bottom:5px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.card-desc{font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:9px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}

/* CARD ACTIONS */
.card-actions{display:flex;gap:6px;margin-top:8px}
.btn-copy-link{flex:1;background:rgba(66,200,245,.1);border:1px solid rgba(66,200,245,.35);color:var(--accent2);font-family:'JetBrains Mono',monospace;font-size:10px;padding:6px 8px;border-radius:3px;cursor:pointer;transition:background .15s;text-align:center}
.btn-copy-link:hover{background:rgba(66,200,245,.2)}
.btn-copy-link.copied{background:rgba(66,245,138,.15);border-color:rgba(66,245,138,.5);color:var(--good)}
.btn-expand{flex:1;background:rgba(245,200,66,.08);border:1px solid rgba(245,200,66,.3);color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:10px;padding:6px 8px;border-radius:3px;cursor:pointer;transition:background .15s}
.btn-expand:hover{background:rgba(245,200,66,.15)}

/* MODAL */
#ad-modal{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:800;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
#ad-modal.open{display:flex}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;width:100%;max-width:640px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;animation:fadeUp .2s ease}
.modal-hdr{display:flex;align-items:flex-start;gap:12px;padding:16px 18px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-title{font-size:14px;color:var(--text);line-height:1.4;flex:1}
.modal-price{font-family:'Unbounded',sans-serif;font-size:18px;color:var(--accent);white-space:nowrap;font-weight:700}
.modal-close{background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:0 2px;line-height:1;flex-shrink:0;margin-top:-2px}
.modal-close:hover{color:var(--text)}
.modal-body{overflow-y:auto;padding:16px 18px;flex:1;display:flex;flex-direction:column;gap:14px}
.modal-img{width:100%;max-height:300px;object-fit:contain;border-radius:4px;background:var(--border)}
.modal-desc-label{font-size:9px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
.modal-desc-text{font-size:12px;color:var(--text);line-height:1.7;white-space:pre-wrap;word-break:break-word}
.modal-desc-loading{font-size:11px;color:var(--muted);font-style:italic}
.modal-meta{display:flex;gap:10px;flex-wrap:wrap;font-size:11px;color:var(--muted)}
.modal-footer{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0}
.modal-btn-copy{flex:1;background:rgba(66,200,245,.1);border:1px solid rgba(66,200,245,.35);color:var(--accent2);font-family:'JetBrains Mono',monospace;font-size:11px;padding:10px;border-radius:4px;cursor:pointer;transition:background .15s}
.modal-btn-copy:hover{background:rgba(66,200,245,.2)}
.modal-btn-copy.copied{background:rgba(66,245,138,.15);border-color:rgba(66,245,138,.5);color:var(--good)}
.modal-btn-open{background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.35);color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:11px;padding:10px 16px;border-radius:4px;cursor:pointer;transition:background .15s;text-decoration:none;text-align:center}
.modal-btn-open:hover{background:rgba(245,200,66,.2)}
.card-meta{display:flex;gap:8px;flex-wrap:wrap;font-size:10px;color:var(--muted);align-items:center}
.tag-co{color:var(--accent2);border:1px solid rgba(66,200,245,.3);font-size:9px;padding:2px 6px;border-radius:2px;text-transform:uppercase;letter-spacing:1px}

.placeholder{text-align:center;padding:80px 20px;color:var(--muted)}
.placeholder .big{font-family:'Unbounded',sans-serif;font-size:52px;margin-bottom:12px;opacity:.2}
.placeholder p{font-size:12px;letter-spacing:1px}
.loader{display:flex;align-items:center;justify-content:center;gap:10px;padding:70px;color:var(--muted);font-size:12px}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error-box{background:rgba(245,66,66,.1);border:1px solid rgba(245,66,66,.3);color:var(--danger);padding:14px;border-radius:4px;font-size:12px;margin-bottom:14px;line-height:1.5}
.pagination{display:flex;justify-content:center;margin-top:22px}
.page-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:10px 24px;font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;border-radius:4px;transition:border-color .15s}
.page-btn:hover{border-color:var(--accent)}
.sidebar-close{display:none;align-self:flex-end;background:var(--border);border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;padding:8px 13px;border-radius:4px;cursor:pointer}

/* ‚ïê‚ïê DEBUG PANEL ‚ïê‚ïê */
#debug-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;display:none;backdrop-filter:blur(3px)}
#debug-overlay.open{display:block}
#debug-panel{position:fixed;right:0;top:0;height:100vh;width:700px;max-width:100vw;background:#080a0f;border-left:2px solid #f54242;z-index:901;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s ease}
#debug-panel.open{transform:translateX(0)}
.dbg-header{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #1e2330;flex-shrink:0;background:#0b0d13}
.dbg-title{font-family:'Unbounded',sans-serif;font-size:13px;color:#f54242;font-weight:700;white-space:nowrap}
.dbg-tabs{display:flex;gap:4px;flex-wrap:wrap}
.dbg-tab{background:transparent;border:1px solid #252b38;color:#6b7689;font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 10px;border-radius:3px;cursor:pointer;transition:all .15s;white-space:nowrap}
.dbg-tab:hover{border-color:#f5c842;color:#e4e8f0}
.dbg-tab.active{border-color:#f54242;color:#f0f0f0;background:rgba(245,66,66,.1)}
.dbg-close{background:transparent;border:none;color:#6b7689;font-size:20px;cursor:pointer;padding:0 4px;line-height:1;margin-left:auto}
.dbg-close:hover{color:#fff}
.dbg-pane{display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0}
.dbg-pane.active{display:flex}
.dbg-toolbar{padding:8px 12px;border-bottom:1px solid #1a1e28;display:flex;gap:7px;flex-shrink:0;flex-wrap:wrap;align-items:center;background:#0d0f14}
.dbg-btn{background:transparent;border:1px solid #252b38;color:#a0a8b8;font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 9px;border-radius:3px;cursor:pointer;transition:all .15s;white-space:nowrap}
.dbg-btn:hover{border-color:#f5c842;color:#f5c842}
.dbg-btn.red:hover{border-color:#f54242;color:#f54242}
.dbg-btn.green{border-color:rgba(66,245,138,.4);color:#42f58a}
.dbg-btn.green:hover{background:rgba(66,245,138,.1)}
.dbg-filter{background:#0d0f14;border:1px solid #252b38;color:#e4e8f0;font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 8px;border-radius:3px;outline:none;width:160px}
.dbg-filter:focus{border-color:#42c8f5}

/* LOG */
#dbg-log{flex:1;overflow-y:auto;padding:6px 0;font-size:11px;line-height:1.55;min-height:0}
.log-entry{padding:3px 14px;border-left:3px solid transparent;display:flex;gap:8px;align-items:flex-start;cursor:pointer;transition:background .1s}
.log-entry:hover{background:rgba(255,255,255,.03)}
.log-entry.INFO .log-lv{color:#42c8f5} .log-entry.INFO{border-color:#42c8f5}
.log-entry.OK   .log-lv{color:#42f58a} .log-entry.OK  {border-color:#42f58a}
.log-entry.WARN .log-lv{color:#f5c842} .log-entry.WARN{border-color:#f5c842}
.log-entry.ERR  .log-lv{color:#f54242} .log-entry.ERR {border-color:#f54242}
.log-entry.DATA .log-lv{color:#c042f5} .log-entry.DATA{border-color:#c042f5}
.log-ts{color:#2a3245;flex-shrink:0;font-size:9px;padding-top:2px}
.log-lv{flex-shrink:0;width:32px;font-size:9px;font-weight:700;text-transform:uppercase;padding-top:1px}
.log-msg{color:#b8bfcc;word-break:break-all;flex:1}
.log-entry.ERR .log-msg{color:#ff8585}
.log-entry.WARN .log-msg{color:#f5d98f}
.log-meta{color:#2f3a50;font-size:9px;flex-shrink:0;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* RAW */
#dbg-raw{flex:1;overflow-y:auto;padding:10px}
.raw-block{margin-bottom:12px;border:1px solid #1e2330;border-radius:4px;overflow:hidden}
.raw-hdr{background:#141820;padding:7px 12px;font-size:10px;color:#6b7689;display:flex;justify-content:space-between}
.raw-hdr span{color:#9aa3b5}
.raw-body{padding:10px 12px;font-size:10px;white-space:pre-wrap;word-break:break-all;color:#8a93a8;max-height:260px;overflow-y:auto;line-height:1.5}
.clr-ok{color:#42f58a} .clr-err{color:#f54242} .clr-warn{color:#f5c842}

/* RATES TABLE */
#dbg-rates{flex:1;overflow-y:auto;padding:10px}
.rt{width:100%;border-collapse:collapse;font-size:11px}
.rt th{background:#141820;padding:7px 10px;text-align:left;color:#6b7689;font-size:9px;text-transform:uppercase;letter-spacing:1px;position:sticky;top:0}
.rt td{padding:6px 10px;border-bottom:1px solid #141820;color:#b8bfcc;vertical-align:middle}
.rt tr:hover td{background:rgba(255,255,255,.02)}
.rc{font-family:'Unbounded',sans-serif;font-weight:700;font-size:12px}
.rc-hot{color:#42f58a} .rc-good{color:#a8f5c0} .rc-ok{color:#f5c842} .rc-bad{color:#f54242}

/* JSON TEST */
#dbg-json-in{flex:1;background:#0d0f14;border:none;border-bottom:1px solid #252b38;color:#c8cdd8;font-family:'JetBrains Mono',monospace;font-size:11px;padding:12px;resize:none;outline:none;min-height:120px;max-height:45%}
#dbg-json-out{flex:1;overflow-y:auto;padding:12px;font-size:11px;white-space:pre-wrap;word-break:break-all;color:#8a93a8;line-height:1.5;min-height:0}

/* STATE */
#dbg-state{flex:1;overflow-y:auto;padding:12px;font-size:11px;line-height:1.8;color:#8a93a8;white-space:pre-wrap;word-break:break-all}

::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:#0a0c10}
::-webkit-scrollbar-thumb{background:#1e2330;border-radius:2px}

@media(max-width:700px){
  .header-tag,.header-count{display:none}
  .btn-filters-toggle{display:block}
  .layout{grid-template-columns:1fr}
  aside{position:fixed;inset:0;width:100%;height:100%;z-index:200;transform:translateX(-100%);border-right:none;padding:16px 14px 90px}
  aside.open{transform:translateX(0)}
  .sidebar-close{display:block!important;margin-bottom:2px}
  main{height:auto;overflow-y:visible;padding:13px 11px}
  .results-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .card-img,.card-no-img{height:125px}
  .card-body{padding:8px 10px}
  .card-price{font-size:13px}
  .card-title{font-size:11px}
  .card-desc{display:none}
  #debug-panel{width:100vw}
}
@media(max-width:390px){
  .results-grid{grid-template-columns:1fr}
  .card-img,.card-no-img{height:160px}
  .card-desc{display:-webkit-box}
  .card-body{padding:11px 12px}
}
</style>
</head>
<body>

<header>
  <div class="logo">KUF<span>AR</span>.PARSE</div>
  <div class="header-tag">v3.1 + AI</div>
  <div class="header-count" id="hdr-count"></div>
  <button class="btn-debug" onclick="openDebug()">üêõ DEBUG</button>
  <button class="btn-filters-toggle" onclick="toggleSidebar()">‚ò∞ –§–∏–ª—å—Ç—Ä—ã</button>
</header>

<div class="layout">
  <aside id="sidebar">
    <button class="sidebar-close" onclick="toggleSidebar()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    <div>
      <div class="section-label">–ü–æ–∏—Å–∫</div>
      <div class="field-group">
        <label>–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ</label>
        <input type="text" id="query" placeholder="iphone, –¥–∏–≤–∞–Ω, –∞–≤—Ç–æ‚Ä¶"/>
      </div>
    </div>
    <hr class="divider">
    <div>
      <div class="section-label">–¶–µ–Ω–∞ BYN (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä)</div>
      <div class="price-row">
        <div class="field-group"><label>–û—Ç</label><input type="number" id="price-min" placeholder="0" min="0"/></div>
        <div class="field-group"><label>–î–æ</label><input type="number" id="price-max" placeholder="‚àû" min="0"/></div>
      </div>
    </div>
    <div class="field-group">
      <label>–ü–æ–∫–∞–∑–∞—Ç—å</label>
      <select id="size">
        <option value="30">30 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</option>
        <option value="60" selected>60 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</option>
        <option value="100">100 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</option>
        <option value="200">200 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</option>
      </select>
    </div>
    <button class="btn-search" id="btn-search" onclick="doSearch(true)">‚ñ∂ –ü–û–ò–°–ö</button>
    <hr class="divider">
    <div>
      <div class="section-label">AI –ê–Ω–∞–ª–∏–∑ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏</div>
      <button class="btn-ai" id="btn-ai" onclick="analyzeWithAI()" disabled>‚ú¶ –ê–ù–ê–õ–ò–ó AI</button>
    </div>
    <div class="ai-status-box" id="ai-status">
      <span id="ai-status-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</span>
      <div class="ai-progress"><div class="ai-progress-fill" id="ai-progress-fill"></div></div>
    </div>
    <button class="btn-export" id="btn-export" onclick="exportCSV()" style="display:none">‚Üì –≠–ö–°–ü–û–†–¢ CSV</button>
    <hr class="divider">
    <div class="proxy-note">
      <strong>‚Ñπ API:</strong> <code>cre-api.kufar.by</code> –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.<br>AI: POE ‚Üí Gemini-2.5-Flash-Lite.
    </div>
  </aside>

  <main id="main">
    <div class="placeholder"><div class="big">‚óà</div><p>–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ –ø–æ–∏—Å–∫</p></div>
  </main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AD MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ad-modal" onclick="handleModalBgClick(event)">
  <div class="modal-box">
    <div class="modal-hdr">
      <div style="flex:1">
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-meta" id="modal-meta" style="margin-top:6px"></div>
      </div>
      <div class="modal-price" id="modal-price"></div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <img class="modal-img" id="modal-img" style="display:none" onerror="this.style.display='none'">
      <div>
        <div class="modal-desc-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
        <div id="modal-desc" class="modal-desc-loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ‚Ä¶</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn-copy" id="modal-copy-btn" onclick="copyModalLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <a class="modal-btn-open" id="modal-open-link" href="#" target="_blank" rel="noopener">‚Üó –û—Ç–∫—Ä—ã—Ç—å</a>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEBUG PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="debug-overlay" onclick="closeDebug()"></div>
<div id="debug-panel">
  <div class="dbg-header">
    <span class="dbg-title">üêõ DEBUG</span>
    <div class="dbg-tabs">
      <button class="dbg-tab active" onclick="showTab('log')">LOG</button>
      <button class="dbg-tab" onclick="showTab('raw')">RAW</button>
      <button class="dbg-tab" onclick="showTab('rates')">RATES</button>
      <button class="dbg-tab" onclick="showTab('json')">JSON TEST</button>
      <button class="dbg-tab" onclick="showTab('state')">STATE</button>
    </div>
    <button class="dbg-close" onclick="closeDebug()">‚úï</button>
  </div>

  <!-- LOG TAB -->
  <div class="dbg-pane active" id="dbg-pane-log">
    <div class="dbg-toolbar">
      <button class="dbg-btn green" onclick="dbgTestKeys()">üîë –¢–µ—Å—Ç –∫–ª—é—á–µ–π POE</button>
      <button class="dbg-btn green" onclick="dbgTestPrompt()">üì§ –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞</button>
      <button class="dbg-btn" onclick="dbgCopyLog()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="dbg-btn red" onclick="dbgClear()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
      <input class="dbg-filter" id="dbg-log-filter" placeholder="–§–∏–ª—å—Ç—Ä‚Ä¶" oninput="dbgApplyFilter()">
    </div>
    <div id="dbg-log"></div>
  </div>

  <!-- RAW TAB -->
  <div class="dbg-pane" id="dbg-pane-raw">
    <div class="dbg-toolbar">
      <button class="dbg-btn red" onclick="rawLog=[];renderRaw()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
      <span style="font-size:10px;color:var(--muted)" id="raw-cnt">0 –∑–∞–ø–∏—Å–µ–π</span>
    </div>
    <div id="dbg-raw"></div>
  </div>

  <!-- RATES TAB -->
  <div class="dbg-pane" id="dbg-pane-rates">
    <div class="dbg-toolbar">
      <button class="dbg-btn" onclick="renderRatesTable()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
      <span style="font-size:10px;color:var(--muted)" id="rates-cnt">0 –æ—Ü–µ–Ω–æ–∫</span>
    </div>
    <div id="dbg-rates"></div>
  </div>

  <!-- JSON TEST TAB -->
  <div class="dbg-pane" id="dbg-pane-json">
    <div class="dbg-toolbar">
      <button class="dbg-btn green" onclick="runJsonTest()">‚ñ∂ –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å</button>
      <button class="dbg-btn" onclick="pasteLastRaw()">‚Üô –ü–æ—Å–ª–µ–¥–Ω–∏–π RAW</button>
      <span style="font-size:10px;color:var(--muted)">–í—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç AI ‚Üí –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å</span>
    </div>
    <textarea id="dbg-json-in" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ raw-—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI‚Ä¶"></textarea>
    <div id="dbg-json-out" style="padding:12px;font-size:11px;white-space:pre-wrap;word-break:break-all;color:#8a93a8;flex:1;overflow-y:auto">‚Üê —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>
  </div>

  <!-- STATE TAB -->
  <div class="dbg-pane" id="dbg-pane-state">
    <div class="dbg-toolbar">
      <button class="dbg-btn" onclick="renderState()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="dbg-btn green" onclick="dbgForceAISort()">‚Üï –§–æ—Ä—Å AI-—Å–æ—Ä—Ç</button>
      <button class="dbg-btn" onclick="dbgResetAI()">‚ü≥ –°–±—Ä–æ—Å AI</button>
    </div>
    <div id="dbg-state"></div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DEBUG ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LOG  = [];
let rawLog = [];
let panelOpen = false;

function log(level, msg, meta) {
  const ts = new Date().toTimeString().slice(0,12).replace(' ','.');
  const entry = { ts, level, msg: String(msg), meta: meta !== undefined ? JSON.stringify(meta).slice(0,200) : '' };
  LOG.push(entry);
  if (panelOpen) _appendEntry(entry);
  (level==='ERR' ? console.error : level==='WARN' ? console.warn : console.log)('['+level+'] '+msg, meta !== undefined ? meta : '');
}

function _appendEntry(e) {
  const el = document.getElementById('dbg-log');
  if (!el) return;
  const d = document.createElement('div');
  d.className = 'log-entry ' + e.level;
  d.dataset.txt = (e.msg+' '+e.meta).toLowerCase();
  d.innerHTML = `<span class="log-ts">${e.ts}</span><span class="log-lv">${e.level}</span>`+
    `<span class="log-msg">${_esc(e.msg)}</span>`+
    (e.meta ? `<span class="log-meta" title="${_esc(e.meta)}">${_esc(e.meta.slice(0,60))}</span>` : '');
  d.onclick = () => { document.getElementById('dbg-json-in').value = e.meta || e.msg; showTab('json'); };
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
}

function _esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function openDebug() {
  document.getElementById('debug-overlay').classList.add('open');
  document.getElementById('debug-panel').classList.add('open');
  panelOpen = true;
  const el = document.getElementById('dbg-log');
  el.innerHTML = '';
  const f = (document.getElementById('dbg-log-filter').value||'').toLowerCase();
  LOG.forEach(e => { if (!f || e.txt && e.txt.includes(f)) _appendEntry(e); });
  el.scrollTop = el.scrollHeight;
}

function closeDebug() {
  document.getElementById('debug-overlay').classList.remove('open');
  document.getElementById('debug-panel').classList.remove('open');
  panelOpen = false;
}

function showTab(name) {
  const names = ['log','raw','rates','json','state'];
  document.querySelectorAll('.dbg-tab').forEach((b,i)=>b.classList.toggle('active', names[i]===name));
  document.querySelectorAll('.dbg-pane').forEach(p=>p.classList.remove('active'));
  document.getElementById('dbg-pane-'+name).classList.add('active');
  if (name==='raw')   renderRaw();
  if (name==='rates') renderRatesTable();
  if (name==='state') renderState();
}

function dbgApplyFilter() {
  const f = (document.getElementById('dbg-log-filter').value||'').toLowerCase();
  document.querySelectorAll('#dbg-log .log-entry').forEach(el => {
    el.style.display = (!f || el.dataset.txt.includes(f)) ? '' : 'none';
  });
}

function dbgClear() { LOG.length=0; document.getElementById('dbg-log').innerHTML=''; log('INFO','–õ–æ–≥ –æ—á–∏—â–µ–Ω'); }
function dbgCopyLog() {
  navigator.clipboard.writeText(LOG.map(e=>`[${e.ts}][${e.level}] ${e.msg} ${e.meta}`).join('\n'))
    .then(()=>log('OK','–õ–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'));
}

function renderRaw() {
  const el = document.getElementById('dbg-raw');
  document.getElementById('raw-cnt').textContent = rawLog.length + ' –∑–∞–ø–∏—Å–µ–π';
  if (!rawLog.length) { el.innerHTML='<div style="padding:20px;color:var(--muted);font-size:11px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
  el.innerHTML = [...rawLog].reverse().map((r,ri)=>{
    const n = rawLog.length - ri;
    const sc = r.ok ? 'clr-ok' : 'clr-err';
    const st = r.ok ? `<span class="clr-ok">HTTP ${r.status} OK</span>` : `<span class="clr-err">FAIL ${r.status||'?'} ${_esc(r.error||'')}</span>`;
    return `<div class="raw-block">
      <div class="raw-hdr"><span>#${n} ${_esc(r.label)} ‚Äî ${r.ts}</span>${st}</div>
      <div class="raw-body ${sc}">${_esc(r.body||'(–ø—É—Å—Ç–æ)')}</div>
    </div>`;
  }).join('');
}

function renderRatesTable() {
  const el = document.getElementById('dbg-rates');
  const entries = Object.entries(aiRates);
  document.getElementById('rates-cnt').textContent = entries.length + ' –æ—Ü–µ–Ω–æ–∫';
  if (!entries.length) { el.innerHTML='<div style="padding:20px;color:var(--muted);font-size:11px">AI –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è</div>'; return; }
  const rows = entries.map(([id,rate])=>{
    const ad = allAds.find(a=>String(a.ad_id)===String(id));
    return { id, rate, title:(ad?ad.subject||'?':'(–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)').slice(0,48) };
  }).sort((a,b)=>b.rate-a.rate);
  el.innerHTML = `<table class="rt"><tr><th>#</th><th>ad_id</th><th>–ö–æ—ç—Ñ.</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
    ${rows.map((r,i)=>{
      const c = r.rate>=1.5?'rc-hot':r.rate>=1.1?'rc-good':r.rate>=0.95?'rc-ok':'rc-bad';
      return `<tr><td>${i+1}</td><td style="color:var(--muted)">${r.id}</td><td class="rc ${c}">√ó${r.rate.toFixed(2)}</td><td>${_esc(r.title)}</td></tr>`;
    }).join('')}
  </table>`;
}

function renderState() {
  const el = document.getElementById('dbg-state');
  el.textContent = JSON.stringify({
    allAds_count: allAds.length,
    aiRates_count: Object.keys(aiRates).length,
    aiAnalyzed, sortByAI,
    decryptedKeys_count: decryptedKeys.length,
    cursor: cursor ? cursor.slice(0,40)+'‚Ä¶' : null,
    first5_rates: allAds.slice(0,5).map(a=>({id:a.ad_id, rate:aiRates[a.ad_id]??'‚Äî'})),
    top5_by_rate: Object.entries(aiRates).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([id,r])=>({id,rate:r}))
  }, null, 2);
}

function dbgForceAISort() {
  log('INFO','–§–æ—Ä—Å-—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: aiAnalyzed='+aiAnalyzed+' sortByAI='+sortByAI+' rates='+Object.keys(aiRates).length);
  if (!Object.keys(aiRates).length) { log('WARN','aiRates –ø—É—Å—Ç–æ–π ‚Äî –Ω–µ—á–µ–≥–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å'); return; }
  aiAnalyzed = true;
  sortByAI   = true;
  updateSortBtn();
  renderResults(allAds.length, allAds.length);
  log('OK','–§–æ—Ä—Å-—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞');
}

function dbgResetAI() {
  aiRates = {}; aiAnalyzed = false; sortByAI = false;
  document.getElementById('ai-status').classList.remove('active');
  document.getElementById('ai-progress-fill').style.width = '0%';
  document.getElementById('btn-ai').textContent = '‚ú¶ –ê–ù–ê–õ–ò–ó AI';
  document.getElementById('btn-ai').disabled = allAds.length === 0;
  updateSortBtn();
  renderResults(allAds.length, allAds.length);
  log('INFO','AI —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ');
}

function runJsonTest() {
  const raw = document.getElementById('dbg-json-in').value.trim();
  const out = document.getElementById('dbg-json-out');
  if (!raw) { out.textContent='–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç'; return; }
  const result = parseAIResponse(raw);
  if (!result) {
    out.innerHTML = `<span style="color:#f54242">‚ùå parseAIResponse –≤–µ—Ä–Ω—É–ª null\n\n</span>${_analyzeFailure(raw)}`;
    return;
  }
  const valid = result.filter(r=>!isNaN(Number(r.ID??r.id))&&!isNaN(Number(r.Rate??r.rate??r.RATE)));
  out.innerHTML = `<span style="color:#42f58a">‚úì –≠–ª–µ–º–µ–Ω—Ç–æ–≤: ${result.length}, –≤–∞–ª–∏–¥–Ω—ã—Ö (ID+Rate): ${valid.length}\n\n</span>`
    + _esc(JSON.stringify(result.slice(0,30), null, 2))
    + (result.length>30 ? `\n‚Ä¶ –µ—â—ë ${result.length-30}` : '');
}

function _analyzeFailure(raw) {
  return `–î–ª–∏–Ω–∞: ${raw.length}\n–°–æ–¥–µ—Ä–∂–∏—Ç '[': ${raw.includes('[')}\n–°–æ–¥–µ—Ä–∂–∏—Ç '{': ${raw.includes('{')}\n`+
    `–ú–∞—Ç—á []: ${(raw.match(/\[[\s\S]*?\]/)||['–Ω–µ—Ç'])[0].slice(0,100)}\n\n`+
    `–ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤.:\n${raw.slice(0,500)}`;
}

function pasteLastRaw() {
  if (!rawLog.length) { log('WARN','–ù–µ—Ç RAW –æ—Ç–≤–µ—Ç–æ–≤'); return; }
  document.getElementById('dbg-json-in').value = rawLog[rawLog.length-1].body || '';
  log('INFO','–ü–æ—Å–ª–µ–¥–Ω–∏–π RAW –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ JSON Test');
}

/* ‚ïê‚ïê‚ïê‚ïê TEST BUTTONS ‚ïê‚ïê‚ïê‚ïê */
async function dbgTestKeys() {
  log('INFO','‚ïê‚ïê –¢–µ—Å—Ç –∫–ª—é—á–µ–π POE ‚ïê‚ïê');
  await fetchAndDecryptKeys();
  if (decryptedKeys.length) {
    log('OK',`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${decryptedKeys.length} –∫–ª—é—á–µ–π. –ü–µ—Ä–≤—ã–π: ‚Ä¶${decryptedKeys[0].slice(-8)}`);
  } else {
    log('ERR','–ù–∏ –æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
  }
}

async function dbgTestPrompt() {
  if (!allAds.length) { log('WARN','–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π'); return; }
  if (!decryptedKeys.length) await fetchAndDecryptKeys();
  if (!decryptedKeys.length) { log('ERR','–ù–µ—Ç –∫–ª—é—á–µ–π'); return; }
  const sample = allAds.slice(0,5).map((ad,i)=>({index:i+1,ad}));
  const block  = buildPromptBlock(sample);
  log('INFO','‚ïê‚ïê –¢–µ—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ —á–µ—Ä–µ–∑ POE (5 –æ–±—ä—è–≤–ª–µ–Ω–∏–π) ‚ïê‚ïê');
  log('DATA','Data block:\n'+block);
  const full = SYSTEM_PROMPT+'\n\n'+block;
  const resp = await callGeminiWithRetry(full);
  if (!resp) { log('ERR','–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç POE'); return; }
  log('OK','–û—Ç–≤–µ—Ç: '+resp.length+' —Å–∏–º–≤.');
  log('DATA', resp);
  const parsed = parseAIResponse(resp);
  if (!parsed) log('ERR','parseAIResponse: null');
  else log('OK',`parseAIResponse: ${parsed.length} —ç–ª.`, parsed.slice(0,5));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AI CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const KEYS_URLS   = ['https://raw.githubusercontent.com/Vaneyn/glistnet/refs/heads/main/freePOE.txt'];
const AI_MODEL    = 'Gemini-2.5-Flash-Lite';   // –∏–º—è –º–æ–¥–µ–ª–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ POE
const AI_BATCH    = 100;
const POE_API     = 'https://api.poe.com/v1/chat/completions';
const SYSTEM_PROMPT = `–¢–´ - –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –∫—É—Ñ–∞—Ä–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–π—Ç–∏ —Å–∞–º—ã–µ –≤—ã–≥–æ–¥–Ω—ã–µ, —á—Ç–æ –∞–∂ –ø–æ –æ—à–∏–±–∫–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –¢—ã –¥–æ–ª–∂–µ–Ω –∫–∞–∂–¥–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É –≤—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ —Ü–µ–Ω—ã –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å —Ä—ã–Ω–æ—á–Ω–æ–π. –ù–∞–ø—Ä–∏–º–µ—Ä 0.90 –∑–Ω–∞—á–∏—Ç —á—Ç–æ —ç—Ç–æ –Ω–µ–º–Ω–æ–≥–æ –Ω–µ –≤—ã–≥–æ–¥–Ω–æ, –∞ 2.00 –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —ç—Ç–æ –≤ 2 —Ä–∞–∑–∞ –¥–µ—à–µ–≤–ª–µ —Ä—ã–Ω–∫–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–π –∫–∞–∫ JSON –≥–¥–µ ID= –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞, Rate = –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ü–µ–Ω—ã. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤–æ–º –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ markdown-–±–ª–æ–∫–æ–≤.`;

let decryptedKeys = [];
let aiRates     = {};
let aiAnalyzed  = false;
let sortByAI    = false;

/* ‚ïê‚ïê‚ïê‚ïê KEY MGMT ‚ïê‚ïê‚ïê‚ïê */
function decryptLine(line) {
  const a='a'.charCodeAt(0),z='z'.charCodeAt(0),A='A'.charCodeAt(0),Z='Z'.charCodeAt(0);
  let out='';
  for (const ch of line) {
    const c=ch.charCodeAt(0);
    if(c>=A&&c<=Z) out+=String.fromCharCode(A+(Z-(((c-A-3)%26+26)%26+A)));
    else if(c>=a&&c<=z) out+=String.fromCharCode(a+(z-(((c-a-3)%26+26)%26+a)));
    else out+=ch;
  }
  return out;
}

async function fetchAndDecryptKeys() {
  decryptedKeys = [];
  for (const url of KEYS_URLS) {
    log('INFO','–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏: '+url);
    try {
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) { log('WARN','HTTP '+r.status); continue; }
      const txt = await r.text();
      const keys = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(decryptLine).filter(k=>k&&k.length>8);
      log(keys.length?'OK':'WARN','–ö–ª—é—á–µ–π —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: '+keys.length+' (—Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: '+txt.split(/\r?\n/).filter(Boolean).length+')');
      if (keys.length) { decryptedKeys = keys; return; }
    } catch(e) { log('ERR','–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–µ–π: '+e.message); }
  }
}

function pickKey(excl=new Set()) {
  const avail = decryptedKeys.map((_,i)=>i).filter(i=>!excl.has(i));
  if (!avail.length) return undefined;
  const idx = avail[Math.floor(Math.random()*avail.length)];
  return { key:decryptedKeys[idx], index:idx };
}

/* ‚ïê‚ïê‚ïê‚ïê GEMINI CALL ‚ïê‚ïê‚ïê‚ïê */
async function callPoe(key, prompt) {
  // POE –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API: Bearer-—Ç–æ–∫–µ–Ω, messages[], choices[0].message.content
  log('INFO', `POE (–∫–ª—é—á ‚Ä¶${key.slice(-6)}), –º–æ–¥–µ–ª—å: ${AI_MODEL}, prompt: ${prompt.length} —Å–∏–º–≤.`);
  try {
    const r = await fetch(POE_API, {
      method: 'POST',
      headers: {
        'Content-Type':  'application/json',
        'Authorization': 'Bearer ' + key
      },
      body: JSON.stringify({
        model:    AI_MODEL,
        messages: [{ role: 'user', content: prompt }],
        stream:   false
      })
    });
    const body = await r.text();
    rawLog.push({ label: 'POE '+AI_MODEL+' ‚Ä¶'+key.slice(-6), ts: new Date().toTimeString().slice(0,8), ok: r.ok, status: r.status, body });
    if (rawLog.length > 30) rawLog.shift();
    if (panelOpen && document.getElementById('dbg-pane-raw').classList.contains('active')) renderRaw();

    if (!r.ok) { log('ERR', 'POE HTTP '+r.status, body.slice(0,300)); return { ok: false }; }
    let data;
    try { data = JSON.parse(body); } catch(e) { log('ERR', 'JSON parse –æ—Ç–≤–µ—Ç–∞ POE: '+e.message, body.slice(0,200)); return { ok: false }; }
    log('OK', 'POE choices: '+(data?.choices?.length??0));
    return { ok: true, data };
  } catch(e) {
    log('ERR', 'fetch exception: '+e.message);
    rawLog.push({ label: 'POE EXCEPTION', ts: new Date().toTimeString().slice(0,8), ok: false, error: e.message, body: String(e) });
    return { ok: false };
  }
}

async function callGeminiWithRetry(prompt) {
  const tried = new Set();
  for (let i = 0; i < Math.max(decryptedKeys.length, 1); i++) {
    const pick = pickKey(tried);
    if (!pick) { log('WARN', '–í—Å–µ –∫–ª—é—á–∏ –ø–µ—Ä–µ–±—Ä–∞–Ω—ã'); break; }
    tried.add(pick.index);
    const res = await callPoe(pick.key, prompt);
    if (!res.ok) continue;
    // OpenAI-compatible response: choices[0].message.content
    const text = res.data?.choices?.[0]?.message?.content || '';
    if (!text) { log('WARN', '–ü—É—Å—Ç–æ–π content –≤ –æ—Ç–≤–µ—Ç–µ POE'); continue; }
    log('OK', '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ ('+text.length+' —Å–∏–º–≤.): '+text.slice(0,80));
    return text;
  }
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê PROMPT BUILDER ‚ïê‚ïê‚ïê‚ïê */
const USD_RATE = 3.25;
function buildPromptBlock(batch) {
  return batch.map(({index,ad})=>{
    const byn = ad.price_byn ? (ad.price_byn/100).toFixed(0) : null;
    const usd = ad.price_usd ? (ad.price_usd/100).toFixed(0) : null;
    let price = '‚Äî';
    if (byn&&usd) price=`${byn} BYN / $${usd} USD`;
    else if (byn) price=`${byn} BYN (~$${(byn/USD_RATE).toFixed(0)} USD)`;
    else if (usd) price=`$${usd} USD (~${(usd*USD_RATE).toFixed(0)} BYN)`;
    const title = (ad.subject||'–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è').slice(0,80);
    const desc  = (ad.description || ad.body||'').replace(/\s+/g,' ').slice(0,300);
    const city  = getCity(ad);
    return `${index}, ${title}${desc?' ‚Äî '+desc:''}${city?' ['+city+']':''}, ${price}`;
  }).join('\n');
}

/* ‚ïê‚ïê‚ïê‚ïê JSON PARSER ‚ïê‚ïê‚ïê‚ïê */
function parseAIResponse(text) {
  if (!text) return null;
  log('DATA','parseAIResponse: –¥–ª–∏–Ω–∞='+text.length+', –Ω–∞—á–∞–ª–æ: '+text.slice(0,80));

  // 1. Strip markdown
  let s = text.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();

  // 2. Find outermost array
  const si = s.indexOf('['), ei = s.lastIndexOf(']');
  if (si !== -1 && ei > si) {
    const chunk = s.slice(si, ei+1);
    // Direct parse
    try { const a=JSON.parse(chunk); log('OK','parseAIResponse direct OK: '+a.length+' —ç–ª.'); return a; } catch {}
    // Fix: trailing commas, unquoted keys
    const fixed = chunk.replace(/,(\s*[}\]])/g,'$1').replace(/([{,]\s*)(\w+)(\s*:)/g,'$1"$2"$3');
    try { const a=JSON.parse(fixed); log('OK','parseAIResponse fixed OK: '+a.length+' —ç–ª.'); return a; } catch(e) { log('WARN','fixed parse fail: '+e.message+'\nChunk: '+chunk.slice(0,200)); }
    // Regex pairs extraction
    const pairs=[];
    const rx = /[{,\s]["\s]*(?:ID|id|Id)["\s]*[=:]\s*(\d+)[\s\S]*?["\s]*(?:Rate|rate|RATE)["\s]*[=:]\s*([\d.]+)/g;
    let m;
    while ((m=rx.exec(chunk))!==null) pairs.push({ID:+m[1],Rate:+m[2]});
    if (pairs.length) { log('OK','parseAIResponse regex: '+pairs.length+' –ø–∞—Ä'); return pairs; }
  }

  // 3. Try single object (possibly wrapped)
  const oi=s.indexOf('{'), oe=s.lastIndexOf('}');
  if (oi!==-1&&oe>oi) {
    try {
      const obj=JSON.parse(s.slice(oi,oe+1));
      if (Array.isArray(obj.results)) return obj.results;
      if (Array.isArray(obj.data))    return obj.data;
      if (obj.ID!==undefined||obj.id!==undefined) return [obj];
    } catch {}
  }

  log('ERR','parseAIResponse: –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å');
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê BADGE HELPERS ‚ïê‚ïê‚ïê‚ïê */
function rateClass(r) { return r>=1.5?'rate-hot':r>=1.1?'rate-good':r>=0.95?'rate-ok':'rate-bad'; }

function setBadge(adId, rate) {
  const el   = document.getElementById('rate-'+adId);
  const card = document.getElementById('card-'+adId);
  if (el) {
    el.textContent = '√ó'+rate.toFixed(2);
    el.className   = 'rate-badge vis ' + rateClass(rate);
  }
  if (card) {
    card.classList.remove('deal-hot','deal-good','deal-bad');
    if      (rate>=1.5)  card.classList.add('deal-hot');
    else if (rate>=1.1)  card.classList.add('deal-good');
    else if (rate<0.95)  card.classList.add('deal-bad');
  }
}

function setLoadingBadge(adId, text='‚Ä¶AI‚Ä¶') {
  const el = document.getElementById('rate-'+adId);
  if (el) { el.textContent=text; el.className='rate-badge vis rate-loading'; }
}

/* ‚ïê‚ïê‚ïê‚ïê SORT BUTTON ‚ïê‚ïê‚ïê‚ïê */
function updateSortBtn() {
  const btn = document.getElementById('ai-sort-btn');
  if (!btn) return;
  btn.style.display = aiAnalyzed ? 'inline-block' : 'none';
  btn.classList.toggle('active', sortByAI);
  btn.textContent = sortByAI ? '‚ú¶ –ü–æ AI ‚Üì' : '‚Üï –°–æ—Ä—Ç. –ø–æ AI';
  log('INFO','updateSortBtn: visible='+aiAnalyzed+' active='+sortByAI);
}

function toggleAISort() {
  log('INFO','toggleAISort: aiAnalyzed='+aiAnalyzed+' rates='+Object.keys(aiRates).length);
  if (!aiAnalyzed) { log('WARN','aiAnalyzed=false, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º'); return; }
  sortByAI = !sortByAI;
  updateSortBtn();
  renderResults(allAds.length, allAds.length);
}

/* ‚ïê‚ïê‚ïê‚ïê MAIN AI FLOW ‚ïê‚ïê‚ïê‚ïê */
async function analyzeWithAI() {
  if (!allAds.length) return;
  const btnAI = document.getElementById('btn-ai');
  const aiBox = document.getElementById('ai-status');
  const aiTxt = document.getElementById('ai-status-text');
  const aiBar = document.getElementById('ai-progress-fill');

  btnAI.disabled = true;
  aiBox.classList.add('active');
  aiTxt.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏‚Ä¶';
  aiBar.style.width = '0%';
  aiRates = {}; aiAnalyzed = false; sortByAI = false;
  log('INFO','‚ïê‚ïê‚ïê‚ïê AI –ê–ù–ê–õ–ò–ó –°–¢–ê–†–¢: '+allAds.length+' –æ–±—ä—è–≤–ª. ‚ïê‚ïê‚ïê‚ïê');

  await fetchAndDecryptKeys();
  if (!decryptedKeys.length) {
    aiTxt.textContent = '‚ùå –ù–µ—Ç –∫–ª—é—á–µ–π';
    log('ERR','–ù–µ—Ç –∫–ª—é—á–µ–π ‚Äî –∞–Ω–∞–ª–∏–∑ –æ—Ç–º–µ–Ω—ë–Ω');
    btnAI.disabled = false;
    return;
  }

  // loading badges
  allAds.forEach(ad => setLoadingBadge(ad.ad_id));

  const indexed = allAds.map((ad,i)=>({index:i+1,ad}));
  const batches = [];
  for (let i=0; i<indexed.length; i+=AI_BATCH) batches.push(indexed.slice(i,i+AI_BATCH));
  log('INFO',`–ü–∞–∫–µ—Ç–æ–≤: ${batches.length} (–ø–æ ${AI_BATCH})`);

  let processed=0, totalRated=0;

  for (let b=0; b<batches.length; b++) {
    const batch = batches[b];
    const range = `${batch[0].index}‚Äì${batch[batch.length-1].index}`;
    aiTxt.textContent = `–ü–∞–∫–µ—Ç ${b+1}/${batches.length} (${range})‚Ä¶`;
    log('INFO',`–ü–∞–∫–µ—Ç ${b+1}/${batches.length}: ${range}`);

    const block = buildPromptBlock(batch);
    log('DATA','Data block (–Ω–∞—á–∞–ª–æ):\n'+block.slice(0,300));
    const responseText = await callGeminiWithRetry(SYSTEM_PROMPT+'\n\n'+block);
    processed += batch.length;
    aiBar.style.width = Math.round(processed/allAds.length*100)+'%';

    if (!responseText) {
      log('ERR',`–ü–∞–∫–µ—Ç ${b+1}: –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞`);
      batch.forEach(({index})=>setLoadingBadge(allAds[index-1]?.ad_id,'?'));
      continue;
    }

    const parsed = parseAIResponse(responseText);
    if (!parsed || !Array.isArray(parsed)) {
      log('ERR',`–ü–∞–∫–µ—Ç ${b+1}: parseAIResponse –≤–µ—Ä–Ω—É–ª null`);
      continue;
    }
    log('OK',`–ü–∞–∫–µ—Ç ${b+1}: —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–æ ${parsed.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);

    let bRated = 0;
    for (const item of parsed) {
      const idx  = Number(item.ID  ?? item.id  ?? item.Id  ?? item['ID'] ?? 0);
      const rate = Number(item.Rate ?? item.rate ?? item.RATE ?? item.–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ?? NaN);
      if (!idx || isNaN(rate)) { log('WARN','–ü—Ä–æ–ø—É—Å–∫–∞–µ–º: –Ω–µ—Ç ID/Rate',item); continue; }
      if (idx < 1 || idx > allAds.length) { log('WARN',`–ò–Ω–¥–µ–∫—Å ${idx} –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ [1..${allAds.length}]`); continue; }

      const ad = allAds[idx-1];
      aiRates[ad.ad_id] = rate;
      setBadge(ad.ad_id, rate);
      bRated++;
    }
    totalRated += bRated;
    log('OK',`–ü–∞–∫–µ—Ç ${b+1}: –ø—Ä–∏–º–µ–Ω–µ–Ω–æ ${bRated}/${batch.length}`);
  }

  aiAnalyzed = true;
  aiTxt.textContent = `‚úì –ì–æ—Ç–æ–≤–æ ‚Äî ${totalRated}/${allAds.length} –æ—Ü–µ–Ω–æ–∫`;
  aiBar.style.width = '100%';
  btnAI.textContent = '‚ú¶ –ü–û–í–¢–û–†–ò–¢–¨';
  btnAI.disabled = false;
  log('OK','‚ïê‚ïê‚ïê‚ïê AI –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù. aiAnalyzed='+aiAnalyzed+' rates='+Object.keys(aiRates).length+' ‚ïê‚ïê‚ïê‚ïê');

  updateSortBtn();
  if (panelOpen) { renderRatesTable(); renderState(); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARSER CORE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CORS_PROXY = 'https://api.allorigins.win/get?url=';
const API_BASE   = 'https://cre-api.kufar.by/ads-search/v1/engine/v1/search/rendered-paginated';
let allAds = [], cursor = null;

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

function buildApiUrl() {
  const q=document.getElementById('query').value.trim(), sz=document.getElementById('size').value;
  const p=new URLSearchParams();
  p.set('lang','ru'); p.set('size',sz);
  if(q)p.set('query',q); if(cursor)p.set('cursor',cursor);
  return API_BASE+'?'+p.toString();
}

function getPrice(ad) {
  if(ad.price_byn)return ad.price_byn/100;
  if(ad.price_usd)return ad.price_usd/100;
  for(const arr of[ad.ad_parameters||[],ad.account_parameters||[]])
    for(const e of arr)if((e.p==='price'||e.p==='prc')&&e.v)return parseFloat(e.v)||null;
  return null;
}

function passesFilter(ad) {
  const mn=parseFloat(document.getElementById('price-min').value);
  const mx=parseFloat(document.getElementById('price-max').value);
  if(isNaN(mn)&&isNaN(mx))return true;
  const p=getPrice(ad); if(p===null)return true;
  if(!isNaN(mn)&&p<mn)return false;
  if(!isNaN(mx)&&p>mx)return false;
  return true;
}

function getCity(ad) {
  for(const arr of[ad.account_parameters||[],ad.ad_parameters||[]])
    for(const e of arr)if(['region','city','area','location'].includes(e.p)&&e.v)return e.v;
  const l=ad.location||{};
  return l.region_name||l.city||l.region||l.name||'';
}

function getDesc(ad){return(ad.description||ad.body||'').trim();}

/* ‚ïê‚ïê‚ïê‚ïê –û–ü–ò–°–ê–ù–ò–ï –¢–û–í–ê–†–ê ‚ïê‚ïê‚ïê‚ïê */
const DESC_SELECTORS = [
  '[class*="description__"]',
  '[class*="Description__"]',
  '[class*="styles_description"]',
  '[class*="ad-description"]',
  '[class*="adDescription"]',
  '[class*="itemDescription"]',
  '[class*="item-description"]',
  '[class*="product-description"]',
  '.description',
  '[data-name="description"]',
  '[itemprop="description"]',
];

function extractDescFromHtml(html) {
  /* 1. –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –∏–∑ Next.js __NEXT_DATA__ JSON ‚Äî —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–± */
  try {
    const m = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
    if (m) {
      const data = JSON.parse(m[1]);
      /* –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏—â–µ–º –ø–æ–ª—è —Å –∏–º–µ–Ω–µ–º description/body/text –≤ –æ–±—ä–µ–∫—Ç–µ */
      function findDesc(obj, depth = 0) {
        if (!obj || typeof obj !== 'object' || depth > 10) return null;
        for (const key of Object.keys(obj)) {
          if (['description', 'body', 'ad_description', 'text'].includes(key.toLowerCase())) {
            const v = obj[key];
            if (typeof v === 'string' && v.trim().length > 10) return v.trim();
          }
          if (typeof obj[key] === 'object') {
            const r = findDesc(obj[key], depth + 1);
            if (r) return r;
          }
        }
        return null;
      }
      const found = findDesc(data);
      if (found) return found;
    }
  } catch {}

  /* 2. CSS-—Å–µ–ª–µ–∫—Ç–æ—Ä—ã */
  const doc = new DOMParser().parseFromString(html, 'text/html');
  for (const sel of DESC_SELECTORS) {
    const el = doc.querySelector(sel);
    if (el) {
      let text = (el.innerText || el.textContent || '').trim();
      if (text.length > 5) return text;
    }
  }

  /* 3. –ü–æ–∏—Å–∫ –ø–æ data-–∞—Ç—Ä–∏–±—É—Ç–∞–º */
  const dataEl = doc.querySelector('[data-testid*="description"],[data-qa*="description"],[data-cy*="description"]');
  if (dataEl) {
    const t = (dataEl.innerText || dataEl.textContent || '').trim();
    if (t.length > 5) return t;
  }

  /* 4. –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –±–ª–æ–∫ —É –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–µ—Ä–µ–¥ –Ω–∏–º –∏–ª–∏ –≤ –Ω—ë–º –µ—Å—Ç—å —Å–ª–æ–≤–æ "–û–ø–∏—Å–∞–Ω–∏–µ" */
  const allEls = doc.querySelectorAll('p,div,section,article');
  for (const el of allEls) {
    const t = (el.innerText || el.textContent || '').trim();
    if (t.startsWith('–û–ø–∏—Å–∞–Ω–∏–µ') && t.length > 15) return t;
  }

  return null;
}

function cleanDesc(text) {
  return text.replace(/^[\s\uFEFF\xA0]*(–æ–ø–∏—Å–∞–Ω–∏–µ|description)[\s\uFEFF\xA0:\-]*/i, '').trim();
}

async function fetchDescription(ad, retryCount = 0) {
  if (ad.description) return;
  const MAX_RETRIES = 5;
  const RETRY_DELAY = [800, 1500, 2500, 4000, 6000];
  const pageUrl = `https://www.kufar.by/item/${ad.ad_id}`;

  let html = null;
  try {
    const r = await fetch(pageUrl, {
      signal: AbortSignal.timeout(10000),
      headers: { 'Accept': 'text/html,application/xhtml+xml', 'Accept-Language': 'ru-RU,ru;q=0.9' }
    });
    if (r.ok) html = await r.text();
    else log('WARN', `fetchDesc ${ad.ad_id}: HTTP ${r.status}, –ø–æ–ø—ã—Ç–∫–∞ ${retryCount+1}`);
  } catch(e) {
    log('WARN', `fetchDesc ${ad.ad_id}: ${e.message}, –ø–æ–ø—ã—Ç–∫–∞ ${retryCount+1}`);
  }

  if (html) {
    const raw = extractDescFromHtml(html);
    if (raw) {
      const text = cleanDesc(raw);
      if (text) {
        ad.description = text;
        updateCardDesc(ad.ad_id, text);
        return;
      }
    }
    /* –ü–æ–ª—É—á–∏–ª–∏ HTML –Ω–æ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è ‚Äî –Ω–µ —Ä–µ—Ç—Ä–∞–∏–º, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–∞–ª—å–Ω–æ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è */
    if (html.length > 5000) {
      log('INFO', `fetchDesc ${ad.ad_id}: HTML –µ—Å—Ç—å (${html.length}–±), –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º–∏`);
      ad.description = ''; /* –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ = "–ø—Ä–æ–≤–µ—Ä–∏–ª–∏, –Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" */
      return;
    }
  }

  /* –†–µ—Ç—Ä–∞–π ‚Äî —Å–µ—Ç—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞ –∏–ª–∏ –æ—Ç–¥–∞–ª–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É */
  if (retryCount < MAX_RETRIES) {
    await new Promise(r => setTimeout(r, RETRY_DELAY[retryCount] || 3000));
    return fetchDescription(ad, retryCount + 1);
  }
  log('ERR', `fetchDesc ${ad.ad_id}: –∏—Å—á–µ—Ä–ø–∞–Ω—ã ${MAX_RETRIES} –ø–æ–ø—ã—Ç–æ–∫`);
}

function updateCardDesc(adId, text) {
  const cardEl = document.getElementById(`card-${adId}`);
  if (!cardEl) return;
  let descEl = cardEl.querySelector('.card-desc');
  if (descEl) {
    descEl.textContent = text;
    descEl.style.cssText = ''; // —É–±—Ä–∞—Ç—å –∫—É—Ä—Å–∏–≤-–∑–∞–≥–ª—É—à–∫—É
  } else {
    const titleEl = cardEl.querySelector('.card-title');
    if (titleEl) {
      const d = document.createElement('div');
      d.className = 'card-desc';
      d.textContent = text;
      titleEl.insertAdjacentElement('afterend', d);
    }
  }
}

async function fetchAllDescriptions(ads) {
  if (!ads.length) return;
  const todo = ads.filter(ad => !ad.description && ad.description !== '');
  if (!todo.length) return;
  log('INFO', `–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ${todo.length} –æ–±—ä—è–≤–ª–µ–Ω–∏–π‚Ä¶`);
  /* –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 6 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á—Ç–æ–±—ã –Ω–µ —Ñ–ª—É–¥–∏—Ç—å */
  const CHUNK = 6;
  for (let i = 0; i < todo.length; i += CHUNK) {
    await Promise.allSettled(todo.slice(i, i + CHUNK).map(ad => fetchDescription(ad)));
  }
  const got = todo.filter(ad => ad.description && ad.description.length > 0).length;
  log('OK', `–û–ø–∏—Å–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${got}/${todo.length}`);
}

async function doSearch(reset=true) {
  if(reset){cursor=null;allAds=[];aiRates={};aiAnalyzed=false;sortByAI=false;}
  document.getElementById('sidebar').classList.remove('open');
  const btn=document.getElementById('btn-search');
  btn.disabled=true; btn.textContent='‚è≥ –ó–ê–ì–†–£–ó–ö–ê‚Ä¶';
  document.getElementById('main').innerHTML=`<div class="loader"><div class="spinner"></div>–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶</div>`;
  const apiUrl=buildApiUrl();
  log('INFO','–ü–æ–∏—Å–∫: '+apiUrl);
  try {
    let data, res;
    try {
      res=await fetch(apiUrl,{headers:{Accept:'application/json'}});
      if(!res.ok)throw new Error(res.status);
      data=await res.json(); log('OK','–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –û–ö');
    } catch(e1) {
      log('WARN','–ü—Ä—è–º–æ–π: '+e1.message+' ‚Üí –ø—Ä–æ–∫—Å–∏');
      res=await fetch(CORS_PROXY+encodeURIComponent(apiUrl));
      if(!res.ok)throw new Error('–ü—Ä–æ–∫—Å–∏: '+res.status);
      data=JSON.parse((await res.json()).contents); log('OK','–ü—Ä–æ–∫—Å–∏ –û–ö');
    }
    const raw=data?.ads||[], filtered=raw.filter(passesFilter);
    allAds=allAds.concat(filtered);
    cursor=data?.pagination?.durationToken||null;
    log('OK',`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${raw.length}, –ø—Ä–æ—à–ª–æ: ${filtered.length}, –≤—Å–µ–≥–æ: ${allAds.length}`);
    renderResults(raw.length,filtered.length);
    document.getElementById('btn-ai').disabled=allAds.length===0;
    fetchAllDescriptions(filtered); // —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π
  } catch(e) {
    log('ERR','doSearch: '+e.message);
    document.getElementById('main').innerHTML=
      `<div class="error-box">‚ùå ${e.message}</div><div class="placeholder"><div class="big">‚úï</div><p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</p></div>`;
  } finally { btn.disabled=false; btn.textContent='‚ñ∂ –ü–û–ò–°–ö'; }
}

/* ‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê */
function renderResults(rawCount, filteredCount) {
  document.getElementById('btn-export').style.display=allAds.length?'block':'none';
  document.getElementById('hdr-count').innerHTML=allAds.length?`<strong>${allAds.length}</strong> –æ–±—ä—è–≤–ª.`:'';

  if(!allAds.length){
    document.getElementById('main').innerHTML=`<div class="placeholder"><div class="big">‚àÖ</div>`+
      `<p>${rawCount>0?'–í—Å–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –ø–æ —Ü–µ–Ω–µ':'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}</p></div>`;
    return;
  }

  let disp=[...allAds];
  if(sortByAI && aiAnalyzed){
    disp.sort((a,b)=>(aiRates[b.ad_id]??0)-(aiRates[a.ad_id]??0));
    log('INFO','renderResults: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ AI. –¢–æ–ø-3: '+disp.slice(0,3).map(a=>`${a.ad_id}(√ó${(aiRates[a.ad_id]??0).toFixed(2)})`).join(', '));
  }

  const note=filteredCount<rawCount?` <span>(–∏–∑ ${rawCount}, —Å–∫—Ä—ã—Ç–æ ${rawCount-filteredCount})</span>`:'';
  let html=`<div class="status-bar">
    <span class="count">${allAds.length}</span><span>–æ–±—ä—è–≤–ª–µ–Ω–∏–π${note}</span>
    <button class="ai-sort-btn${sortByAI?' active':''}" id="ai-sort-btn"
      onclick="toggleAISort()" style="display:${aiAnalyzed?'inline-block':'none'}">
      ${sortByAI?'‚ú¶ –ü–æ AI ‚Üì':'‚Üï –°–æ—Ä—Ç. –ø–æ AI'}</button>
  </div><div class="results-grid">`;

  for(const ad of disp) html+=renderCard(ad);
  html+=`</div>`;
  if(cursor)html+=`<div class="pagination"><button class="page-btn" onclick="loadMore()">‚Üì –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button></div>`;

  document.getElementById('main').innerHTML=html;

  // Restore badges
  if(aiAnalyzed){
    let restored=0;
    for(const ad of disp){
      const r=aiRates[ad.ad_id];
      if(r!==undefined){setBadge(ad.ad_id,r);restored++;}
    }
    log('INFO','renderResults: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ '+restored+' –±–µ–π–¥–∂–µ–π');
  }
}

function renderCard(ad) {
  const link=`https://www.kufar.by/item/${ad.ad_id}`;
  const subject=ad.subject||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', desc=getDesc(ad), city=getCity(ad);
  const isCo=ad.account_type==='company';
  const rawP=getPrice(ad);
  let priceStr='‚Äî';
  if(rawP!==null) priceStr=(!ad.price_byn&&ad.price_usd)?`$${rawP.toFixed(0)}`:`${rawP.toFixed(0)} BYN`;
  let date='';
  try{if(ad.list_time)date=new Date(ad.list_time).toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'2-digit'});}catch{}

  const imgs=ad.images||[];
  let imgHtml, imgUrl='';
  if(imgs.length){
    const img=imgs[0];
    if(img.path)imgUrl=img.yams_storage?`https://yams.kufar.by/v1/gallery/${img.path}`:`https://rms.kufar.by/v1/gallery/${img.path}`;
    else{const sid=typeof(img.id??img)==='string'?img.id??img:'';if(sid)imgUrl=`https://yams.kufar.by/api/v1/kufar-ads/images/${sid.slice(0,2)}/${sid}.jpg?rule=list`;}
    imgHtml=imgUrl?`<img class="card-img" src="${imgUrl}" loading="lazy" onerror="this.outerHTML='<div class=card-no-img>NO PHOTO</div>'">`:`<div class="card-no-img">NO PHOTO</div>`;
  }else imgHtml=`<div class="card-no-img">NO PHOTO</div>`;

  const adData=JSON.stringify({id:ad.ad_id,link,subject,priceStr,city,date,imgUrl,isCo}).replace(/'/g,'&#39;');

  return`<div class="card" id="card-${ad.ad_id}">
    <span class="rate-badge" id="rate-${ad.ad_id}"></span>
    ${imgHtml}
    <div class="card-body">
      <div class="card-price">${priceStr}</div>
      <div class="card-title">${esc(subject)}</div>
      ${desc?`<div class="card-desc">${esc(desc)}</div>`:`<div class="card-desc" style="color:var(--border);font-style:italic">–∑–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ‚Ä¶</div>`}
      <div class="card-meta">
        ${city?`<span>üìç ${esc(city)}</span>`:''}
        ${date?`<span>üïê ${date}</span>`:''}
        ${isCo?`<span class="tag-co">–ö–û–ú–ü–ê–ù–ò–Ø</span>`:''}
      </div>
      <div class="card-actions">
        <button class="btn-expand" onclick="openModal('${ad.ad_id}')">‚§¢ –†–∞—Å–∫—Ä—ã—Ç—å</button>
        <button class="btn-copy-link" onclick="copyLink(event,'${link}',this)">üìã –°—Å—ã–ª–∫–∞</button>
      </div>
    </div>
  </div>`;
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
async function loadMore(){await doSearch(false);}

function exportCSV(){
  if(!allAds.length)return;
  const rows=[['ID','–ù–∞–∑–≤–∞–Ω–∏–µ','–û–ø–∏—Å–∞–Ω–∏–µ','–¶–µ–Ω–∞','–ì–æ—Ä–æ–¥','–î–∞—Ç–∞','AI –ö–æ—ç—Ñ.','–°—Å—ã–ª–∫–∞']];
  for(const ad of allAds){
    const p=getPrice(ad);
    const pStr=p!==null?((!ad.price_byn&&ad.price_usd)?`$${p.toFixed(2)}`:`${p.toFixed(2)} BYN`):'';
    rows.push([ad.ad_id||'',`"${(ad.subject||'').replace(/"/g,'""')}"`,
      `"${getDesc(ad).replace(/"/g,'""').replace(/\n/g,' ')}"`,pStr,getCity(ad),
      ad.list_time?new Date(ad.list_time).toLocaleDateString('ru-RU'):'',
      aiRates[ad.ad_id]!==undefined?aiRates[ad.ad_id].toFixed(2):'',
      `https://www.kufar.by/item/${ad.ad_id}`]);
  }
  const blob=new Blob(['\uFEFF'+rows.map(r=>r.join(',')).join('\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  Object.assign(document.createElement('a'),{href:url,download:'kufar.csv'}).click();
  URL.revokeObjectURL(url);
}

/* ‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê */
let _modalAdId = null;
function openModal(adId) {
  const ad = allAds.find(a=>String(a.ad_id)===String(adId));
  if (!ad) return;
  _modalAdId = adId;
  const link = `https://www.kufar.by/item/${ad.ad_id}`;
  const rawP = getPrice(ad);
  let priceStr = '‚Äî';
  if (rawP!==null) priceStr = (!ad.price_byn&&ad.price_usd)?`$${rawP.toFixed(0)}`:`${rawP.toFixed(0)} BYN`;

  document.getElementById('modal-title').textContent = ad.subject||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  document.getElementById('modal-price').textContent = priceStr;
  document.getElementById('modal-open-link').href = link;

  const city = getCity(ad);
  let date = '';
  try{if(ad.list_time)date=new Date(ad.list_time).toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'2-digit'});}catch{}
  const metaEl = document.getElementById('modal-meta');
  metaEl.innerHTML = [
    city?`<span>üìç ${esc(city)}</span>`:'',
    date?`<span>üïê ${date}</span>`:'',
    ad.account_type==='company'?`<span class="tag-co">–ö–û–ú–ü–ê–ù–ò–Ø</span>`:''
  ].join('');

  /* –§–æ—Ç–æ */
  const imgs = ad.images||[];
  const imgEl = document.getElementById('modal-img');
  let imgUrl = '';
  if (imgs.length) {
    const img = imgs[0];
    if (img.path) imgUrl = img.yams_storage?`https://yams.kufar.by/v1/gallery/${img.path}`:`https://rms.kufar.by/v1/gallery/${img.path}`;
    else { const sid=typeof(img.id??img)==='string'?img.id??img:''; if(sid)imgUrl=`https://yams.kufar.by/api/v1/kufar-ads/images/${sid.slice(0,2)}/${sid}.jpg?rule=gallery`; }
  }
  if (imgUrl) { imgEl.src=imgUrl; imgEl.style.display='block'; } else { imgEl.style.display='none'; }

  /* –û–ø–∏—Å–∞–Ω–∏–µ */
  const descEl = document.getElementById('modal-desc');
  if (ad.description) {
    descEl.className = 'modal-desc-text';
    descEl.textContent = ad.description;
  } else {
    descEl.className = 'modal-desc-loading';
    descEl.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ‚Ä¶';
    fetchDescription(ad).then(()=>{
      if (_modalAdId !== adId) return;
      if (ad.description) {
        descEl.className = 'modal-desc-text';
        descEl.textContent = ad.description;
      } else {
        descEl.textContent = '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
      }
    });
  }

  const copyBtn = document.getElementById('modal-copy-btn');
  copyBtn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É';
  copyBtn.classList.remove('copied');
  document.getElementById('ad-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  _modalAdId = null;
  document.getElementById('ad-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function handleModalBgClick(e) {
  if (e.target === document.getElementById('ad-modal')) closeModal();
}

function copyModalLink() {
  const link = document.getElementById('modal-open-link').href;
  navigator.clipboard.writeText(link).then(()=>{
    const btn = document.getElementById('modal-copy-btn');
    btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
    btn.classList.add('copied');
    setTimeout(()=>{ btn.textContent='üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É'; btn.classList.remove('copied'); }, 2000);
  });
}

function copyLink(e, url, btn) {
  e.stopPropagation();
  navigator.clipboard.writeText(url).then(()=>{
    const orig = btn.textContent;
    btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
    btn.classList.add('copied');
    setTimeout(()=>{ btn.textContent=orig; btn.classList.remove('copied'); }, 2000);
  });
}

document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

document.getElementById('query').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch(true);});
log('INFO','Kufar Parser + AI v3.1 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
</script>
</body>
</html>
